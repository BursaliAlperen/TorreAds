<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TorreAds - Reklam İzle, TRON Kazan</title>
    
    <script src="https://adexora.com/cdn/ads.js?id=507"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Telegram Theme Variables */
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #1e293b;
            --tg-theme-button-color: #3b82f6; /* Telegram Mavisi */
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-hint-color: #cbd5e1; /* Açık Gri (Çok hafif) */
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --tg-theme-bg-color: #1e293b;
                --tg-theme-text-color: #f8fafc;
                --tg-theme-hint-color: #475569; /* Koyu Modda Orta Gri */
            }
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
            /* YENİ: Hafif Arka Plan Gradienti */
            background-image: linear-gradient(135deg, var(--tg-theme-bg-color) 0%, #f7f9fc 100%);
        }

        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* 1. GELİŞMİŞ BALANCE CARD - Gradient ve Derinlik */
        .balance-card {
            background: linear-gradient(45deg, #4c96fa, #2a7cf5); /* Canlı Mavi Gradient */
            color: var(--tg-theme-button-text-color);
            padding: 20px;
            border-radius: 15px; /* Daha yuvarlak */
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4); /* Derin Mavi Gölge */
            transition: all 0.3s ease-in-out;
            transform: perspective(1px) translateZ(0);
        }
        .balance-card:hover {
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.5);
            transform: translateY(-2px); /* Hafif yukarı kayma efekti */
        }
        .balance-card p {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            /* YENİ: Bakiye Metnine Titreşim/Pulse Animasyonu */
            animation: pulse 2s infinite ease-in-out; 
        }

        /* 2. DİNAMİK BUTONLAR */
        .action-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px; 
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s, transform 0.1s, box-shadow 0.2s;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); /* Buton gölgesi */
        }

        .btn-primary:active:not(:disabled) {
            background-color: #1e40af; /* Daha derin bir mavi */
            transform: scale(0.95); /* Butonun içeri çökmesi */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); /* Gölgenin azalması */
        }

        .btn-secondary:active:not(:disabled) {
            background-color: #334155; /* Daha koyu gri */
            transform: scale(0.95);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* 3. LIFTED INFO CARDS (Derinlikli Kartlar) */
        .info-card {
            background-color: var(--tg-theme-bg-color);
            border: none; /* Kenarlığı kaldır, gölgeye güven */
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08); /* Daha belirgin gölge */
            transition: all 0.3s ease-out;
        }
        .info-card:hover {
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        /* 4. ANİMASYON KEYFRAMES */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.95; transform: scale(1.01); }
        }

        @keyframes viewTransition {
            from { opacity: 0; transform: translateY(20px); } /* Daha belirgin kayma */
            to { opacity: 1; transform: translateY(0); }
        }

        .view {
            display: none;
        }

        .view.active {
            display: block;
            animation: viewTransition 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Akıcı geçiş */
        }
        
        /* 5. TAB BAR EFEKTLERİ */
        .tab-bar {
            /* ... mevcut stiller ... */
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1);
        }
        .tab-button {
            /* ... mevcut stiller ... */
            transition: color 0.2s, transform 0.1s;
        }
        .tab-button.active {
            color: var(--tg-theme-button-color);
            transform: translateY(-2px); /* Aktif buton hafifçe kalkar */
            font-weight: 600;
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.3); /* Hafif parlama */
        }
        .tab-button:active {
            transform: scale(0.9); /* Daha belirgin tıklama */
        }

        /* Admin Panel Kartları için daha belirgin stil */
        .user-card {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            background-color: var(--tg-theme-bg-color);
            border-left: 5px solid var(--tg-theme-button-color); /* Vurgu çizgisi */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease-out;
        }
        .user-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateX(2px);
        }
        
        .user-card button {
            transition: all 0.1s;
        }
        
        .user-card button:active {
             transform: scale(0.95);
        }

        /* Status Message */
        .status-message {
            /* ... existing styles ... */
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            animation: popIn 0.3s ease-out;
        }
        
        @keyframes popIn {
            from { opacity: 0; transform: translateX(-50%) scale(0.8); }
            to { opacity: 1; transform: translateX(-50%) scale(1); }
        }
    </style>
</head>
<body>
    
    <div id="loading" style="text-align: center; padding: 50px; font-size: 1.2rem;">
        <i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i> Uygulama Yükleniyor...
    </div>

    <div id="statusMessage" class="status-message"></div>
    
    <div id="app-container" class="container" style="display: none;">
        <div class="header">
            <h1 id="appTitle">TorreAds <span id="userIdDisplay"></span></h1>
        </div>

        <div class="content-area">
            
            <div id="main-view" class="view active">
                
                <div class="balance-card">
                    <h2>Mevcut Bakiye (TRX)</h2>
                    <p id="balanceDisplay">TRX 0.0000</p>
                    <p style="font-size: 0.9rem; font-weight: 400; margin-top: 5px;" id="usdEquivalent">≈ $0.00</p>
                </div>
                
                <button id="rewardedBtn" class="action-button btn-primary">
                    <i class="fas fa-video"></i> Reklam İzle ve Kazan
                </button>
                
                <p style="text-align: center; font-size: 0.9rem; color: var(--tg-theme-hint-color); margin-top: 15px;">
                    Bugün İzlenen Reklam: <span id="dailyAdCountDisplay">0 / 200</span>
                </p>

                <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--tg-theme-hint-color);">

                <div class="info-card">
                    <h3>Genel İstatistikler</h3>
                    <p>Toplam İzlenen Reklam: <span id="adCountDisplay">0</span></p>
                    <p>Toplam Çekilen Miktar: <span id="totalWithdrawalsDisplay">0 TRX</span></p>
                    <p>Toplam Dağıtılan Ödül: <span id="totalTRXDistributedDisplay">0 TRX</span></p>
                    <p>Güncel TRX Fiyatı: <span id="trxPriceDisplay">$0.00</span></p>
                </div>
            </div>

            <div id="withdraw-view" class="view">
                <div class="balance-card" style="background: linear-gradient(45deg, #16a34a, #10b981); box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);">
                    <h2>Çekilebilir Bakiye (TRX)</h2>
                    <p id="withdrawBalanceDisplay">TRX 0.0000</p>
                </div>
                
                <div class="input-group">
                    <label for="trxAddress">TRON (TRX) Cüzdan Adresi</label>
                    <input type="text" id="trxAddress" placeholder="TRX cüzdan adresinizi girin (T ile başlamalı)">
                </div>

                <p style="color: var(--tg-theme-hint-color); margin-top: 5px; text-align: center; font-size: 0.85rem;">
                    Minimum çekim miktarı <span id="minWithdrawalAmount">5</span> TRX'dir.
                </p>
                
                <button id="mainWithdrawBtn" class="action-button btn-secondary" onclick="showView('withdraw-final-view')">
                    <i class="fas fa-money-bill-wave"></i> Para Çek
                </button>
            </div>

            <div id="withdraw-final-view" class="view">
                <h3 style="text-align: center;">Çekim İşlemini Onayla</h3>
                <div class="info-card">
                    <p>Çekilecek Miktar: <span id="finalWithdrawAmountDisplay"></span></p>
                    <p>Cüzdan Adresi: <span id="finalWithdrawAddressDisplay"></span></p>
                </div>
                
                <button id="finalWithdrawBtn" class="action-button btn-primary" onclick="submitWithdrawal()">
                    <i class="fas fa-check-circle"></i> Onayla ve Çekim Talebi Oluştur
                </button>

                <button class="action-button btn-secondary" onclick="showView('withdraw-view')">
                    <i class="fas fa-arrow-left"></i> Geri Dön
                </button>
            </div>

            <div id="referral-view" class="view">
                <div class="info-card">
                    <h3>Davet Et, Kazan!</h3>
                    <p>Davet ettiğiniz her kullanıcı için size ve davet ettiğiniz kişiye <b><span id="referralBonusDisplay">$0.02</span></b> değerinde TRX hediye edilir.</p>
                    <p>Toplam Kazandığınız Referans Bonusu: <b><span id="referralBonusTotalDisplay">0.00 TRX</span></b></p>
                </div>
                
                <p>Davet Linkiniz:</p>
                <div class="referral-link">
                    <input type="text" id="referralLink" value="Yükleniyor..." readonly>
                    <button onclick="copyReferralCode()"><i class="fas fa-copy"></i> Kopyala</button>
                </div>
                
                <p style="margin-top: 20px;">Davet Edilen Kişi Sayısı: <span id="referredCountDisplay">0</span></p>
                
                <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--tg-theme-hint-color);">
                
                <div id="referralCodeInputGroup" style="display: none;">
                    <h3 style="margin-bottom: 10px;">Davet Kodu Gir</h3>
                    <div class="input-group">
                        <input type="text" id="referralCodeInput" placeholder="Davet Kodunu Buraya Girin">
                    </div>
                    <button class="action-button btn-primary" onclick="submitReferralCode()">
                        <i class="fas fa-arrow-alt-circle-right"></i> Kodu Uygula
                    </button>
                </div>
            </div>

            <div id="admin-view" class="view">
                <div class="admin-controls info-card" style="border-left: 5px solid var(--danger-color); box-shadow: 0 8px 15px rgba(239, 68, 68, 0.2);">
                    <h3>Yönetici Paneli (Gelişmiş)</h3>
                    <p style="color: var(--danger-color); font-weight: bold;">
                        DİKKAT: Tüm Admin Fonksiyonları SADECE Güvenli Sunucu (Backend) Üzerinden Çalışmalıdır. Bu görünüm sadece bir arayüz örneğidir.
                    </p>
                </div>

                <div class="info-card" style="margin-top: 20px;">
                    <h3>Bekleyen Çekim Talepleri (<span id="withdrawalCount">0</span>)</h3>
                    <ul id="withdrawalList" class="withdrawal-list">
                        <li id="noWithdrawalsMessage" style="text-align: center; color: var(--tg-theme-hint-color);">Bekleyen çekim talebi yok.</li>
                    </ul>
                </div>

                <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--tg-theme-hint-color);">

                <div class="info-card">
                    <h3>Tüm Kullanıcılar (<span id="userCountDisplay">0</span>)</h3>
                    <div id="userList" class="user-list-section">
                        <p style="text-align: center; color: var(--tg-theme-hint-color);">Kullanıcılar Yükleniyor...</p>
                    </div>
                </div>
            </div>

        </div> <div class="tab-bar">
            <button class="tab-button active" data-view="main-view" onclick="showView('main-view')">
                <i class="fas fa-home"></i> Ana Sayfa
            </button>
            <button class="tab-button" data-view="withdraw-view" onclick="showView('withdraw-view')">
                <i class="fas fa-wallet"></i> Çekim
            </button>
            <button class="tab-button" data-view="referral-view" onclick="showView('referral-view')">
                <i class="fas fa-users"></i> Davet
            </button>
            <button id="adminTabBtn" class="tab-button" data-view="admin-view" onclick="showView('admin-view')" style="display: none;">
                <i class="fas fa-user-shield"></i> Admin
            </button>
        </div>
    </div> <script>
        // --- KRİTİK AYAR ---
        const BOT_USERNAME = 'YOUR_BOT_USERNAME'; // <--- BURAYA KENDİ BOT KULLANICI ADINIZI YAZIN! (Örn: 'TorreAds_Bot')

        // --- GÜVENLİK BİLGİLENDİRMESİ VE MOCK API AYARLARI ---
        const BIN_ID = '68e2b3ebd0ea881f40965de6';
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}/latest`;
        const UPDATE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const SECURE_SERVER_ENDPOINT = 'YOUR_SECURE_BACKEND_API_ENDPOINT'; 

        const tg = window.Telegram.WebApp;

        let userData = null;
        let appData = {
            users: {},
            system: {
                adminUsers: ['8401848644', '7904032877'], 
                DAILY_AD_LIMIT: 200,             
                MIN_WITHDRAWAL_TRX: 5,           
                AD_REWARD_USD: 0.001,            
                REFERRAL_BONUS_USD: 0.02,        
                
                totalAds: 0,
                totalWithdrawals: 0,
                totalTRXDistributed: 0,
                lastAdReset: new Date().toDateString(),
                trxPrice: 0.12, 
                trxChange: 0,
            },
            withdrawRequests: []
        };
        let trxPrice = 0.12;
        let trxChange = 0;


        // JSONBin.io'dan veri yükleme (Legacy/Güvensiz Yöntem - MOCK için kullanılıyor)
        async function loadAppDataLegacy() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.record;
            } catch (error) {
                console.error('Legacy Veri Yükleme Başarısız:', error);
                return null;
            }
        }

        // JSONBin.io'ya veri kaydetme (Legacy/Güvensiz Yöntem - MOCK için kullanılıyor)
        async function saveAppDataLegacy(data) {
            try {
                const response = await fetch(UPDATE_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Bin-Versioning': 'false'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Legacy Veri Kaydetme Başarısız:', error);
                return false;
            }
        }
        
        // Simüle Edilmiş Güvenli Sunucu API'si (KRİTİK İŞLEMLER BURADAN YAPILMALI)
        const secureServer = {
            async fetchAppData() { return loadAppDataLegacy(); },
            async saveAppData(data) { return saveAppDataLegacy(data); },
            async adminAddBalance(targetId, amount) { 
                const data = await loadAppDataLegacy();
                if (data.users[targetId]) {
                    data.users[targetId].balance += amount;
                    await saveAppDataLegacy(data);
                    showStatus(`MOCK: ${targetId} kullanıcısına ${amount} TRX eklendi.`, 'warning'); 
                    return true;
                }
                showStatus('MOCK: Kullanıcı bulunamadı.', 'error'); 
                return false;
            },
            async adminBlockUser(userId, blockStatus) { 
                const data = await loadAppDataLegacy();
                if (data.users[userId]) {
                    data.users[userId].isBlocked = blockStatus;
                    await saveAppDataLegacy(data);
                    showStatus(`MOCK: ${userId} kullanıcısı ${blockStatus ? 'BLOKE EDİLDİ' : 'BLOKESİ KALDIRILDI'}.`, 'warning'); 
                    return true;
                }
                showStatus('MOCK: Kullanıcı bulunamadı.', 'error');
                return false;
            },
            async approveWithdrawal(requestId) { showStatus('KRİTİK HATA: Onaylama fonksiyonu sunucuya taşınmalıdır.', 'error'); return false; },
            async rejectWithdrawal(requestId) { showStatus('KRİTİK HATA: Reddetme fonksiyonu sunucuya taşınmalıdır.', 'error'); return false; }
        };


        // --- YARDIMCI İŞLEVLER ---

        function usdToTRX(usd) {
            return trxPrice > 0 ? usd / trxPrice : 0;
        }

        function getUserId() {
            return tg.initDataUnsafe.user ? String(tg.initDataUnsafe.user.id) : null;
        }

        function checkAdminStatus() {
            const userId = getUserId();
            return userId && appData.system.adminUsers.includes(userId);
        }

        function checkDailyReset() {
            const today = new Date().toDateString();

            if (appData.system.lastAdReset !== today) {
                appData.system.lastAdReset = today;
            }

            if (userData.lastAdDate !== today) {
                userData.dailyAdCount = 0;
                userData.lastAdDate = today;
            }
        }

        function updateUI() {
            if (!userData) return;
            
            const dailyLimit = appData.system.DAILY_AD_LIMIT;
            const refBonus = appData.system.REFERRAL_BONUS_USD;

            document.getElementById('balanceDisplay').textContent = `TRX ${userData.balance.toFixed(4)}`;
            const usdEquivalent = userData.balance * trxPrice;
            document.getElementById('usdEquivalent').textContent = `≈ $${usdEquivalent.toFixed(4)}`;
            document.getElementById('withdrawBalanceDisplay').textContent = `TRX ${userData.balance.toFixed(4)}`;

            document.getElementById('adCountDisplay').textContent = appData.system.totalAds;
            document.getElementById('dailyAdCountDisplay').textContent = `${userData.dailyAdCount} / ${dailyLimit}`;

            document.getElementById('totalWithdrawalsDisplay').textContent = `${appData.system.totalWithdrawals.toFixed(2)} TRX`;
            document.getElementById('totalTRXDistributedDisplay').textContent = `${appData.system.totalTRXDistributed.toFixed(2)} TRX`;
            document.getElementById('trxPriceDisplay').textContent = `$${trxPrice.toFixed(4)}`;

            document.getElementById('referralBonusDisplay').textContent = `$${refBonus}`;
            document.getElementById('referredCountDisplay').textContent = userData.referredUsers.length;
            document.getElementById('referralBonusTotalDisplay').textContent = `${userData.referralBonus.toFixed(4)} TRX`;
            
            const userId = getUserId();
            document.getElementById('referralLink').value = `https://t.me/${BOT_USERNAME}?start=${userId}`;

            if (checkAdminStatus()) {
                document.getElementById('adminTabBtn').style.display = 'block';
                renderWithdrawalRequests();
                renderUserList(); 
            } else {
                 document.getElementById('adminTabBtn').style.display = 'none';
            }
            
            updateWithdrawButton();
        }

        function updateWithdrawButton() {
            const mainWithdrawBtn = document.getElementById('mainWithdrawBtn');
            const finalWithdrawBtn = document.getElementById('finalWithdrawBtn');
            const minWithdrawal = appData.system.MIN_WITHDRAWAL_TRX;

            if (userData.balance >= minWithdrawal) {
                mainWithdrawBtn.disabled = false;
                mainWithdrawBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Para Çek';
                
                const address = document.getElementById('trxAddress').value.trim() || userData.paymentAddress;
                if (address && address.startsWith('T') && address.length >= 34) { 
                    finalWithdrawBtn.disabled = false;
                } else {
                    finalWithdrawBtn.disabled = true;
                }
            } else {
                mainWithdrawBtn.disabled = true;
                const remaining = (minWithdrawal - userData.balance).toFixed(2);
                mainWithdrawBtn.innerHTML = `<i class="fas fa-money-bill-wave"></i> Çekim İçin ${remaining} TRX Eksik`;
                finalWithdrawBtn.disabled = true;
            }
        }
        
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`.tab-button[data-view="${viewId.replace('-final-view', '-view')}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            if (viewId === 'withdraw-final-view') {
                const address = document.getElementById('trxAddress').value.trim();
                const amount = userData.balance.toFixed(4);

                userData.paymentAddress = address; 
                document.getElementById('finalWithdrawAmountDisplay').textContent = `${amount} TRX`;
                document.getElementById('finalWithdrawAddressDisplay').textContent = address;
                
                updateWithdrawButton();
            }
            
            tg.ready();
        }
        
        // --- ANA UYGULAMA İŞLEVLERİ (initApp, loadTRXPrice, watchAd, submitWithdrawal, applyReferralCode aynı kaldı) ---

        async function initApp() {
            tg.ready();
            tg.expand();
            tg.MainButton.hide();

            const loadedData = await secureServer.fetchAppData();
            if (loadedData) {
                appData = {...appData, ...loadedData};
            }

            const userId = getUserId();
            if (!userId) {
                document.getElementById('loading').textContent = 'Kullanıcı kimliği alınamadı. Lütfen Telegram içinden açın.';
                return;
            }
            
            document.getElementById('userIdDisplay').textContent = `(${tg.initDataUnsafe.user.username || tg.initDataUnsafe.user.id})`;

            if (!appData.users[userId]) {
                userData = {
                    balance: 0,
                    adCount: 0,
                    dailyAdCount: 0,
                    lastAdDate: new Date().toDateString(),
                    referredBy: null,
                    referredUsers: [],
                    referralBonus: 0,
                    paymentAddress: '',
                    isBlocked: false,
                    lastUpdated: Date.now()
                };
                appData.users[userId] = userData;
                await secureServer.saveAppData(appData); 
            } else {
                userData = appData.users[userId];
            }
            
            await loadTRXPrice();

            checkDailyReset();
            const startParam = tg.initDataUnsafe.start_param;
            if (startParam && startParam !== userId && userData.referredBy === null) {
                await applyReferralCode(startParam);
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('trxAddress').value = userData.paymentAddress;
            
            if (userData.referredBy !== null) {
                document.getElementById('referralCodeInputGroup').style.display = 'none';
            } else {
                document.getElementById('referralCodeInputGroup').style.display = 'block';
            }
            
            updateUI();
            
            startPeriodicUpdates();
        }
        
        async function loadTRXPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tron&vs_currencies=usd&include_24hr_change=true');
                if (!response.ok) {
                    throw new Error('CoinGecko API error');
                }
                const data = await response.json();
                
                if (data.tron) {
                    trxPrice = data.tron.usd;
                    trxChange = data.tron.usd_24h_change;
                    appData.system.trxPrice = trxPrice; 
                    updateUI(); 
                }
            } catch (error) {
                console.error('TRX Fiyatı yüklenemedi, varsayılan kullanılıyor:', error);
            }
        }
        
        async function watchAd() {
            const btn = document.getElementById('rewardedBtn');
            const adLimit = appData.system.DAILY_AD_LIMIT;
            const adReward = appData.system.AD_REWARD_USD;

            checkDailyReset(); 

            if (userData.dailyAdCount >= adLimit) {
                showStatus('Günlük reklam limitine ulaştınız. Yarın tekrar deneyin.', 'error', 3000);
                return;
            }
            
            if (userData.isBlocked) {
                showStatus('Hesabınız bloke edilmiştir. Destek ile iletişime geçin.', 'error', 3000);
                return;
            }

            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const rewarded = await window.adexora.showRewarded();
                
                if (rewarded) {
                    const rewardAmount = usdToTRX(adReward); 
                    
                    userData.balance += rewardAmount;
                    userData.adCount += 1;
                    userData.dailyAdCount += 1;
                    userData.lastUpdated = Date.now();
                    
                    appData.system.totalAds += 1; 
                    appData.system.totalTRXDistributed += rewardAmount;
                    
                    await secureServer.saveAppData(appData);
                    
                    showStatus(`Tebrikler! ${rewardAmount.toFixed(4)} TRX kazandınız.`, 'success', 3000);
                } else {
                    showStatus('Reklam gösterilemedi veya izlenmedi.', 'error', 3000);
                }
                
            } catch (error) {
                console.error('Reklam izleme hatası:', error);
                showStatus('Bir hata oluştu. Tekrar deneyin.', 'error', 3000);
            } finally {
                await secureServer.fetchAppData(); 
                updateUI();
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        async function submitWithdrawal() {
            const address = userData.paymentAddress.trim();
            const minWithdrawal = appData.system.MIN_WITHDRAWAL_TRX;
            const amount = userData.balance;

            if (!address || !address.startsWith('T') || address.length < 34) {
                showStatus('Geçerli bir TRON cüzdan adresi girin.', 'error', 3000);
                return;
            }

            if (amount < minWithdrawal) {
                showStatus(`Minimum çekim miktarı ${minWithdrawal} TRX'dir.`, 'error', 3000);
                return;
            }
            
            if (userData.isBlocked) {
                showStatus('Hesabınız bloke edilmiştir.', 'error', 3000);
                return;
            }

            const finalWithdrawBtn = document.getElementById('finalWithdrawBtn');
            finalWithdrawBtn.classList.add('btn-loading');
            finalWithdrawBtn.disabled = true;

            try {
                const withdrawalRequest = {
                    id: Date.now(),
                    userId: getUserId(),
                    username: tg.initDataUnsafe.user.username || 'N/A',
                    amount: amount,
                    address: address,
                    date: new Date().toLocaleDateString('tr-TR'),
                    status: 'Beklemede'
                };
                
                appData.system.totalWithdrawals += amount; 
                userData.balance = 0;
                userData.lastUpdated = Date.now();
                appData.withdrawRequests.push(withdrawalRequest);

                await secureServer.saveAppData(appData);
                
                showStatus('Çekim talebiniz başarıyla oluşturuldu. En kısa sürede onaylanacaktır.', 'success', 5000);
                showView('main-view'); 
            } catch (error) {
                console.error('Çekim talebi hatası:', error);
                showStatus('Çekim talebi gönderilirken bir hata oluştu.', 'error', 3000);
            } finally {
                await secureServer.fetchAppData();
                updateUI();
                finalWithdrawBtn.classList.remove('btn-loading');
            }
        }

        async function applyReferralCode(referralCode) {
            const referrerId = referralCode;
            const referredId = getUserId();
            const referrer = appData.users[referrerId];
            const bonusAmount = usdToTRX(appData.system.REFERRAL_BONUS_USD);

            if (referrerId === referredId) {
                showStatus('Kendi referans kodunuzu giremezsiniz.', 'error', 3000);
                return false;
            }

            if (userData.referredBy !== null) {
                showStatus('Zaten bir referans kodu kullandınız.', 'error', 3000);
                return false;
            }

            if (!referrer) {
                showStatus('Geçersiz referans kodu.', 'error', 3000);
                return false;
            }
            
            try {
                userData.balance += bonusAmount;
                userData.referralBonus += bonusAmount;
                userData.referredBy = referrerId;
                userData.lastUpdated = Date.now();
                
                referrer.balance += bonusAmount;
                referrer.referralBonus += bonusAmount;
                referrer.referredUsers.push(referredId);
                referrer.lastUpdated = Date.now();
                
                await secureServer.saveAppData(appData); 
                
                showStatus(`Başarılı! ${bonusAmount.toFixed(4)} TRX referans bonusu kazandınız.`, 'success', 5000);
                
                document.getElementById('referralCodeInputGroup').style.display = 'none';
                return true;
                
            } catch (error) {
                console.error('Referans kodu uygulama hatası:', error);
                showStatus('Referans kodu uygulanırken bir hata oluştu.', 'error', 3000);
                return false;
            } finally {
                await secureServer.fetchAppData(); 
                updateUI();
            }
        }

        function submitReferralCode() {
            const code = document.getElementById('referralCodeInput').value.trim();
            if (code) {
                applyReferralCode(code);
            } else {
                showStatus('Lütfen bir davet kodu girin.', 'error', 3000);
            }
        }
        
        // --- YÖNETİCİ İŞLEVLERİ ---

        function renderWithdrawalRequests() {
            const list = document.getElementById('withdrawalList');
            const requests = appData.withdrawRequests.filter(r => r.status === 'Beklemede');
            
            list.innerHTML = '';
            document.getElementById('withdrawalCount').textContent = requests.length;

            if (requests.length === 0) {
                list.innerHTML = `<li id="noWithdrawalsMessage" style="text-align: center; color: var(--tg-theme-hint-color);">Bekleyen çekim talebi yok.</li>`;
                return;
            }

            requests.forEach(req => {
                 const item = document.createElement('li');
                 item.className = 'withdrawal-item';
                 item.innerHTML = `
                    <div class="withdrawal-details">
                        <b>${req.amount.toFixed(4)} TRX</b> | ${req.username} (${req.userId})
                        <p style="font-size: 0.8rem; color: var(--tg-theme-hint-color); margin: 0;">Adres: ${req.address.substring(0, 10)}...</p>
                    </div>
                    <div class="withdrawal-actions">
                        <button class="btn-approve" onclick="secureServer.approveWithdrawal(${req.id})"><i class="fas fa-check"></i> Onayla</button>
                        <button class="btn-reject" onclick="secureServer.rejectWithdrawal(${req.id})"><i class="fas fa-times"></i> Reddet</button>
                    </div>
                 `;
                 list.appendChild(item);
            });
        }
        
        // YENİ FONKSİYON: Kullanıcı Listesini Render Et
        function renderUserList() {
            const listContainer = document.getElementById('userList');
            const users = appData.users;
            const userKeys = Object.keys(users);

            document.getElementById('userCountDisplay').textContent = userKeys.length;
            listContainer.innerHTML = ''; 

            userKeys.forEach(userId => {
                const user = users[userId];
                
                if (!user) return; 

                const card = document.createElement('div');
                card.className = 'user-card';
                
                const lastLoginDate = new Date(user.lastUpdated).toLocaleString('tr-TR');
                const blockBtnClass = user.isBlocked ? 'btn-approve' : 'btn-reject';
                const blockBtnText = user.isBlocked ? 'Engeli Kaldır' : 'Engelle';

                card.innerHTML = `
                    <h4>Kullanıcı ID: ${userId} ${user.isBlocked ? '(<span style="color: var(--danger-color); font-size: 0.9rem;">BLOKE</span>)' : ''}</h4>
                    <p>Bakiye: <b>${user.balance.toFixed(4)} TRX</b></p>
                    <p>Reklam Sayısı: ${user.adCount} (Bugün: ${user.dailyAdCount})</p>
                    <p>Davet Eden: ${user.referredBy || 'Yok'}</p>
                    <p>Davetli Sayısı: ${user.referredUsers.length}</p>
                    <p style="color: var(--tg-theme-hint-color);">Son İşlem: ${lastLoginDate}</p>
                    <div class="user-actions" style="margin-top: 10px;">
                        <button class="action-button btn-primary" style="width: auto;" onclick="secureServer.adminAddBalance('${userId}', 10).then(updateUI)">+10 TRX Ekle (MOCK)</button>
                        <button class="action-button ${blockBtnClass}" style="width: auto;" onclick="secureServer.adminBlockUser('${userId}', ${!user.isBlocked}).then(updateUI)">${blockBtnText} (MOCK)</button>
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }
        
        // --- PERİYODİK GÜNCELLEMELER ---

        function startPeriodicUpdates() {
            setInterval(async () => {
                const loadedData = await secureServer.fetchAppData();
                if (loadedData) {
                    appData = {...appData, ...loadedData};
                    if (appData.users[getUserId()]) {
                        userData = appData.users[getUserId()];
                        checkDailyReset();
                        updateUI();
                    }
                }
            }, 10000);
            
            setInterval(async () => {
                await loadTRXPrice();
            }, 300000);
        }
        
        // --- UTILITY (YARDIMCI) İŞLEVLER ---

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus('Kopyalandı!', 'success', 1000);
            }).catch(err => {
                console.error('Copy failed:', err);
                showStatus('Kopyalama başarısız. Manuel olarak kopyalayın.', 'error', 2000);
            });
        }
        
        function copyReferralCode() {
            const link = document.getElementById('referralLink').value;
            copyToClipboard(link);
        }

        function showStatus(message, type, duration = 3000) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, duration);
        }
        
        // Olay dinleyicileri
        document.getElementById('rewardedBtn').addEventListener('click', watchAd);
        document.getElementById('trxAddress').addEventListener('input', updateWithdrawButton);
        document.addEventListener('DOMContentLoaded', initApp);

        // Global Erişimler
        window.showView = showView;
        window.copyReferralCode = copyReferralCode;
        window.submitWithdrawal = submitWithdrawal;
        window.submitReferralCode = submitReferralCode;
        window.updateUI = updateUI;
        
        // Admin Mock Fonksiyonları
        window.adminAddBalance = secureServer.adminAddBalance;
        window.adminBlockUser = secureServer.adminBlockUser;
        window.approveWithdrawal = secureServer.approveWithdrawal;
        window.rejectWithdrawal = secureServer.rejectWithdrawal;
    </script>
</body>
</html>
