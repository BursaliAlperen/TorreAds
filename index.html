<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Torre Earn App</title>
    
    <!-- Google Fonts (Nunito) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        /* Ã–nceki CSS kodlarÄ± aynen kalacak, sadece referans kÄ±smÄ±nÄ± gÃ¼ncelliyorum */
        
        /* Referral Success Animation */
        .referral-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            animation: bounceIn 0.6s ease-out;
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .bonus-badge {
            background: #ffd700;
            color: #856404;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="light-theme">

    <div id="app">
        <!-- Ã–nceki HTML yapÄ±sÄ± aynen kalacak -->
        
        <main id="main-content">
            <!-- Home Page -->
            <div id="home-page" class="page active">
                <h2>Dashboard</h2>
                <div id="error-message" class="error-message"></div>
                
                <!-- Referral Success Message -->
                <div id="referral-success" class="referral-success" style="display: none;">
                    <i class="fas fa-gift fa-2x" style="margin-bottom: 10px;"></i>
                    <h3>ðŸŽ‰ Welcome Bonus! ðŸŽ‰</h3>
                    <p>You received <strong>$0.02</strong> for joining through a referral link!</p>
                </div>
                
                <!-- Debug Info -->
                <div class="debug-info" id="debug-info">
                    <strong>Debug Information:</strong><br>
                    <span id="debug-content">Initializing...</span>
                </div>
                
                <!-- Kalan kÄ±sÄ±m aynen kalacak -->
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let tg = null;
        let userState = {
            points: 0,
            dailyAdWatchCount: 0,
            lastAdWatchDate: null,
            referrals: [],
            referralEarnings: 0,
            hasJoinedChannel: false,
            hasJoinedGroup: false,
            userId: null,
            username: "",
            hasReceivedReferralBonus: false // Yeni eklenen alan
        };

        // Configuration - REFERRAL BONUS'u artÄ±rÄ±yorum
        const CONFIG = {
            JSONBIN_API_KEY: "$2a$10$t0i.TuifzioNY0cd8HzoDOxB94YLcVc.gbHkv.qmFQzFJcbl9uVrK",
            JSONBIN_BIN_ID: "68da76fad0ea881f408f1248",
            PIPEDREAM_WEBHOOK: "https://eo3h4zf914hhqv7.m.pipedream.net",
            BOT_USERNAME: "TorreAds_Bot",
            CHANNEL_LINK: "https://t.me/Torrelabs",
            GROUP_LINK: "https://t.me/torreAdsChat",
            DAILY_AD_LIMIT: 100,
            POINTS_PER_AD: 0.0005,
            CHANNEL_JOIN_BONUS: 0.10,
            GROUP_JOIN_BONUS: 0.05,
            REFERRAL_BONUS: 0.05, // $0.02'den $0.05'e Ã§Ä±kardÄ±m
            MIN_WITHDRAW_POINTS: 0.50
        };

        // DOM Elements
        const elements = {
            // Ã–nceki elementler aynen kalacak
            referralSuccess: document.getElementById('referral-success')
        };

        // YENÄ° REFERANS SÄ°STEMÄ° - Basit ve Etkili
        async function checkAndApplyReferral() {
            debugLog('=== REFERRAL CHECK STARTED ===');
            
            // 1. Telegram start_param kontrolÃ¼
            if (tg?.startParam) {
                debugLog('Telegram startParam found: ' + tg.startParam);
                if (tg.startParam.startsWith('ref_')) {
                    const referrerId = tg.startParam.replace('ref_', '');
                    await applyReferralBonus(referrerId);
                    return;
                }
            }
            
            // 2. URL parametreleri kontrolÃ¼
            const urlParams = new URLSearchParams(window.location.search);
            const startParam = urlParams.get('start');
            if (startParam && startParam.startsWith('ref_')) {
                debugLog('URL start param found: ' + startParam);
                const referrerId = startParam.replace('ref_', '');
                await applyReferralBonus(referrerId);
                return;
            }
            
            // 3. Telegram initData kontrolÃ¼
            if (tg?.initData) {
                try {
                    const initParams = new URLSearchParams(tg.initData);
                    const startParam = initParams.get('start');
                    if (startParam && startParam.startsWith('ref_')) {
                        debugLog('InitData start param found: ' + startParam);
                        const referrerId = startParam.replace('ref_', '');
                        await applyReferralBonus(referrerId);
                        return;
                    }
                } catch (error) {
                    debugLog('Error parsing initData: ' + error.message);
                }
            }
            
            // 4. Hash parametreleri kontrolÃ¼ (fallback)
            const hashParams = window.location.hash.substring(1);
            if (hashParams.includes('ref_')) {
                const refMatch = hashParams.match(/ref_([a-zA-Z0-9]+)/);
                if (refMatch) {
                    debugLog('Hash ref param found: ' + refMatch[0]);
                    await applyReferralBonus(refMatch[1]);
                    return;
                }
            }
            
            debugLog('No referral parameters found');
        }

        // REFERANS BONUS UYGULAMA - Basit ve DoÄŸrudan
        async function applyReferralBonus(referrerId) {
            debugLog('Applying referral bonus from: ' + referrerId);
            
            // Kendi kendine referans kontrolÃ¼
            if (referrerId === userState.userId?.toString()) {
                debugLog('Self-referral detected, skipping');
                return;
            }
            
            // Ã‡ift referans kontrolÃ¼
            if (userState.referrals.includes(referrerId)) {
                debugLog('Already referred by this user: ' + referrerId);
                return;
            }
            
            // Bonus zaten verilmiÅŸ mi kontrolÃ¼
            if (userState.hasReceivedReferralBonus) {
                debugLog('Referral bonus already received');
                return;
            }
            
            debugLog('âœ… ELIGIBLE FOR REFERRAL BONUS!');
            
            // Bonusu uygula
            userState.points += CONFIG.REFERRAL_BONUS;
            userState.referrals.push(referrerId);
            userState.referralEarnings += CONFIG.REFERRAL_BONUS;
            userState.hasReceivedReferralBonus = true;
            
            debugLog('Referral bonus applied: +$' + CONFIG.REFERRAL_BONUS);
            debugLog('New balance: $' + userState.points);
            debugLog('Total referrals: ' + userState.referrals.length);
            
            // Hemen kaydet
            await saveState();
            
            // UI'Ä± gÃ¼ncelle
            updateUI();
            
            // BaÅŸarÄ± mesajÄ±nÄ± gÃ¶ster
            showReferralSuccess();
            
            // Haptic feedback
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
            
            // Referans veren kullanÄ±cÄ±ya da bonus ver (opsiyonel - JSONBin Ã¼zerinden)
            await giveBonusToReferrer(referrerId);
        }

        // REFERANS VEREN KULLANICIYA BONUS VER
        async function giveBonusToReferrer(referrerId) {
            try {
                debugLog('Giving bonus to referrer: ' + referrerId);
                
                // Ã–nce mevcut veriyi al
                const response = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': CONFIG.JSONBIN_API_KEY }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    let allData = data.record || {};
                    
                    // Referans veren kullanÄ±cÄ±yÄ± bul
                    if (allData[referrerId]) {
                        const referrerState = allData[referrerId];
                        referrerState.points += CONFIG.REFERRAL_BONUS;
                        referrerState.referralEarnings += CONFIG.REFERRAL_BONUS;
                        
                        // GÃ¼ncelle ve kaydet
                        allData[referrerId] = referrerState;
                        
                        await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.JSONBIN_BIN_ID}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Master-Key': CONFIG.JSONBIN_API_KEY
                            },
                            body: JSON.stringify(allData)
                        });
                        
                        debugLog('Bonus given to referrer: ' + referrerId);
                    } else {
                        debugLog('Referrer not found in database: ' + referrerId);
                    }
                }
            } catch (error) {
                debugLog('Error giving bonus to referrer: ' + error.message);
            }
        }

        // REFERANS BAÅžARI MESAJI
        function showReferralSuccess() {
            elements.referralSuccess.style.display = 'block';
            
            // 5 saniye sonra gizle
            setTimeout(() => {
                elements.referralSuccess.style.display = 'none';
            }, 5000);
            
            // Popup da gÃ¶ster
            showSuccess(`ðŸŽ‰ Welcome! You received $${CONFIG.REFERRAL_BONUS} referral bonus!`);
        }

        // TEST REFERANS SÄ°STEMÄ° - Manuel test iÃ§in
        function testReferralSystem() {
            debugLog('=== TESTING REFERAL SYSTEM ===');
            
            // Test referans ID'si
            const testReferrerId = 'test_referrer_123';
            
            // Bonus uygula
            userState.points += CONFIG.REFERRAL_BONUS;
            userState.referrals.push(testReferrerId);
            userState.referralEarnings += CONFIG.REFERRAL_BONUS;
            
            debugLog('TEST: Referral bonus applied: +$' + CONFIG.REFERRAL_BONUS);
            debugLog('TEST: New balance: $' + userState.points);
            
            // UI'Ä± gÃ¼ncelle
            updateUI();
            
            // BaÅŸarÄ± mesajÄ±nÄ± gÃ¶ster
            showReferralSuccess();
            
            // Kaydet
            saveState();
        }

        // MANUEL REFERANS LINKI OLUÅžTURMA
        function createManualReferralLink() {
            const userId = userState.userId || 'demo_user';
            const referralLink = `https://t.me/${CONFIG.BOT_USERNAME}?start=ref_${userId}`;
            
            debugLog('Manual referral link: ' + referralLink);
            
            // Kopyala
            navigator.clipboard.writeText(referralLink).then(() => {
                showSuccess('Referral link copied! Share: ' + referralLink);
            });
            
            return referralLink;
        }

        // GÃœNCELLENMÄ°Åž MAIN INITIALIZATION
        async function initApp() {
            debugLog('=== APP INITIALIZATION STARTED ===');
            
            // Telegram'Ä± baÅŸlat
            const telegramInitialized = initTelegram();
            
            // KullanÄ±cÄ± ID'sini al
            userState.userId = getUserId();
            debugLog('User ID set: ' + userState.userId);
            
            // State'i yÃ¼kle
            debugLog('Loading user state for: ' + userState.userId);
            await loadState(userState.userId);
            
            // YENÄ°: Referans kontrolÃ¼ - HER ZAMAN Ã‡ALIÅžSIN
            await checkAndApplyReferral();
            
            // GÃ¼nlÃ¼k sÄ±fÄ±rlama
            const today = new Date().toISOString().slice(0, 10);
            if (userState.lastAdWatchDate !== today) {
                userState.dailyAdWatchCount = 0;
                userState.lastAdWatchDate = today;
                await saveState();
            }
            
            // TON fiyatÄ±
            await getTONPrice();
            
            // UI ve event'ler
            updateUI();
            setupNavigation();
            setupEventListeners();
            
            // Ana iÃ§eriÄŸi gÃ¶ster
            showMainContent();
            
            debugLog('=== APP INITIALIZATION COMPLETED ===');
            debugLog('Final balance: $' + userState.points);
            debugLog('Total referrals: ' + userState.referrals.length);
            debugLog('Referral earnings: $' + userState.referralEarnings);
            
            // TEST: Manuel referans butonu ekle (sadece debug iÃ§in)
            addTestButtons();
        }

        // TEST BUTONLARI EKLE (sadece geliÅŸtirme iÃ§in)
        function addTestButtons() {
            const testDiv = document.createElement('div');
            testDiv.style.marginTop = '10px';
            testDiv.style.padding = '10px';
            testDiv.style.background = '#f8f9fa';
            testDiv.style.borderRadius = '8px';
            testDiv.innerHTML = `
                <strong>Developer Tools:</strong><br>
                <button onclick="testReferralSystem()" style="padding: 5px 10px; margin: 2px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Test Referral
                </button>
                <button onclick="createManualReferralLink()" style="padding: 5px 10px; margin: 2px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Get Referral Link
                </button>
                <button onclick="location.reload()" style="padding: 5px 10px; margin: 2px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Reload App
                </button>
            `;
            elements.debugInfo.appendChild(testDiv);
        }

        // Kalan fonksiyonlar (saveState, loadState, updateUI, vs.) Ã¶nceki gibi kalacak
        // Sadece updateUI'da kÃ¼Ã§Ã¼k bir gÃ¼ncelleme:

        function updateUI() {
            // ... Ã¶nceki kodlar ...
            
            // Referans bonus badge ekle
            if (userState.referrals.length > 0) {
                elements.userName.innerHTML = `${user.first_name || ''} ${user.last_name || ''} 
                    <i class="fas fa-check-circle verified-icon"></i>
                    <span class="bonus-badge">${userState.referrals.length} ref</span>`;
            }
            
            // ... kalan kodlar ...
        }

        // UygulamayÄ± baÅŸlat
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initApp, 100);
        });

    </script>
</body>
                    </html>
