<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TorreAds</title>
    
    <!-- GigaPub SDK -->
    <script src="https://ad.gigapub.tech/script?id=986"></script>

    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        :root {
            --tg-theme-bg-color: #121212; --tg-theme-text-color: #e0e0e0; --tg-theme-button-color: #007bff;
            --tg-theme-button-text-color: #ffffff; --tg-theme-hint-color: #8a8a8a; --success-color: #28a745;
            --warning-color: #ffc107; --danger-color: #dc3545; --secondary-bg-color: #1e1e1e; --border-color: #333333;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0;
            padding: 20px 15px 120px 15px; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color);
            display: flex; flex-direction: column; align-items: center; text-align: center; min-height: 100vh; box-sizing: border-box;
        }
        .container { width: 100%; max-width: 500px; }
        .view { display: none; width: 100%; animation: fadeIn 0.3s ease-in-out; }
        #home-view { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .header { margin-bottom: 25px; }
        .header h1 { font-size: 32px; font-weight: 700; margin-bottom: 5px; color: #ffffff; }
        .header p { color: var(--tg-theme-hint-color); font-size: 16px; }
        .card {
            background-color: var(--secondary-bg-color); padding: 25px; border-radius: 16px; margin-bottom: 25px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); border: 1px solid var(--border-color);
        }
        .card h2 {
            margin: 0 0 12px 0; font-size: 16px; color: var(--tg-theme-hint-color); font-weight: 500;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .balance-amount { font-size: 42px; font-weight: 700; color: #ffffff; margin-bottom: 10px; }
        .ad-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center; }
        .ad-info-item h3 { font-size: 20px; font-weight: 600; margin: 0 0 5px 0; color: #ffffff; }
        .ad-info-item p { font-size: 14px; color: var(--tg-theme-hint-color); margin: 0; }
        .ad-buttons { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .btn {
            width: 100%; padding: 16px; font-size: 18px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer;
            transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
            background: linear-gradient(145deg, var(--tg-theme-button-color), #0056b3); color: var(--tg-theme-button-text-color);
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0, 123, 255, 0.3); }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background: #555; color: #888; cursor: not-allowed; box-shadow: none; transform: none; }
        #mainWithdrawBtn { background: linear-gradient(145deg, var(--success-color), #1e7e34); box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2); }
        #mainWithdrawBtn:disabled { background: #555; box-shadow: none; }
        .status-message {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 480px;
            padding: 12px 15px; border-radius: 10px; font-weight: 500; display: none; animation: fadeIn 0.3s;
            z-index: 1000; box-sizing: border-box;
        }
        .success { display: block; background-color: rgba(40, 167, 69, 0.25); border-left: 5px solid var(--success-color); color: var(--success-color); }
        .error { display: block; background-color: rgba(220, 53, 69, 0.25); border-left: 5px solid var(--danger-color); color: var(--danger-color); }
        .info { display: block; background-color: rgba(0, 123, 255, 0.25); border-left: 5px solid var(--tg-theme-button-color); color: #008cff; }
        .footer-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--secondary-bg-color); display: flex;
            justify-content: space-around; padding: 10px 0; box-shadow: 0 -4px 12px rgba(0,0,0,0.3);
            border-top: 1px solid var(--border-color); z-index: 999;
        }
        .nav-btn {
            background: none; border: none; color: var(--tg-theme-hint-color); display: flex; flex-direction: column;
            align-items: center; font-size: 12px; font-weight: 500; cursor: pointer; padding: 5px 15px;
            border-radius: 12px; transition: color 0.2s, background-color 0.2s;
        }
        .nav-btn.active { color: var(--tg-theme-button-color); }
        .nav-btn:hover:not(.active) { color: #ffffff; }
        .nav-btn .icon { width: 28px; height: 28px; margin-bottom: 4px; }
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; margin-bottom: 8px; color: var(--tg-theme-hint-color); font-size: 14px; font-weight: 500; }
        .input-group input {
            width: 100%; padding: 14px; border-radius: 10px; border: 1px solid var(--border-color);
            background-color: #333; color: var(--tg-theme-text-color); font-size: 16px; box-sizing: border-box;
        }
        .input-group input:focus { outline: none; border-color: var(--tg-theme-button-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
        #referralLink {
            background-color: #111; padding: 15px; border-radius: 10px; word-wrap: break-word;
            border: 1px dashed var(--tg-theme-hint-color); margin-top: 15px; cursor: pointer; color: #e0e0e0;
            transition: background-color 0.2s; text-align: left;
        }
        #referralLink:hover { background-color: #2a2a2a; }
        
        /* Yeni referans giri≈ü kutusu stilleri */
        .referral-input-container {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--secondary-bg-color);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }
        
        .referral-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .referral-input-group input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: #333;
            color: var(--tg-theme-text-color);
        }
        
        .referral-input-group button {
            padding: 12px 20px;
            background: linear-gradient(145deg, var(--tg-theme-button-color), #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Loading indicator */
        .btn-loading {
            position: relative;
            pointer-events: none;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin-left: -10px;
            margin-top: -10px;
            border: 2px solid transparent;
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* TON Price Chart Styles */
        .price-chart {
            background-color: var(--secondary-bg-color);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border: 1px solid var(--border-color);
        }
        
        .price-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .current-price {
            font-size: 18px;
            font-weight: bold;
        }
        
        .price-change {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 6px;
        }
        
        .price-change.positive {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }
        
        .price-change.negative {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }
        
        .chart-placeholder {
            height: 60px;
            background: linear-gradient(90deg, #333 0%, #444 50%, #333 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--tg-theme-hint-color);
            font-size: 14px;
        }

        /* Referans kod kutusu */
        .referral-code-box {
            background-color: #111;
            padding: 15px;
            border-radius: 10px;
            border: 1px dashed var(--tg-theme-hint-color);
            margin-top: 15px;
            cursor: pointer;
            color: #e0e0e0;
            transition: background-color 0.2s;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            letter-spacing: 2px;
        }
        
        .referral-code-box:hover {
            background-color: #2a2a2a;
        }

        /* Admin Panel Stilleri */
        .admin-panel {
            display: none;
            margin-top: 30px;
            padding: 15px;
            border: 1px solid var(--warning-color);
            border-radius: 10px;
            background-color: rgba(255, 193, 7, 0.1);
        }
        
        .admin-panel h3 {
            color: var(--warning-color);
            margin-top: 0;
        }
        
        .admin-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        
        .admin-btn {
            padding: 10px 15px;
            background: linear-gradient(145deg, var(--warning-color), #e0a800);
            color: #000;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }
        
        .admin-btn:hover {
            transform: translateY(-2px);
        }
        
        .admin-btn.danger {
            background: linear-gradient(145deg, var(--danger-color), #c82333);
            color: white;
        }
        
        .admin-stats {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 14px;
            text-align: left;
        }
        
        /* Yeni Admin Aray√ºz√º */
        .admin-dashboard {
            display: none;
            margin-top: 20px;
        }
        
        .admin-nav {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .admin-nav-btn {
            padding: 15px;
            background: linear-gradient(145deg, var(--warning-color), #e0a800);
            color: #000;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: transform 0.2s ease;
        }
        
        .admin-nav-btn:hover {
            transform: translateY(-2px);
        }
        
        .admin-section {
            display: none;
            margin-top: 20px;
        }
        
        .admin-section.active {
            display: block;
        }
        
        /* Dil se√ßimi modalƒ± */
        .language-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .language-modal-content {
            background-color: var(--secondary-bg-color);
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .language-modal h2 {
            margin-top: 0;
            color: #ffffff;
            margin-bottom: 20px;
        }
        
        .language-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .language-option {
            padding: 12px;
            background-color: #333;
            border: none;
            border-radius: 8px;
            color: var(--tg-theme-text-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .language-option:hover {
            background-color: #444;
        }
        
        .language-option.selected {
            background-color: var(--tg-theme-button-color);
            color: white;
        }
        
        .language-confirm-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        .language-confirm-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .language-confirm-checkbox input {
            width: 18px;
            height: 18px;
        }
        
        .language-confirm-btn {
            padding: 12px 24px;
            background: linear-gradient(145deg, var(--tg-theme-button-color), #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
        }
        
        .language-confirm-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        /* G√∂revler pazarƒ± */
        .tasks-container {
            margin-top: 20px;
        }
        
        .task-card {
            background-color: var(--secondary-bg-color);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            text-align: left;
        }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .task-title {
            font-weight: bold;
            font-size: 16px;
        }
        
        .task-reward {
            background-color: var(--success-color);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .task-description {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            margin-bottom: 10px;
        }
        
        .task-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .task-progress-bar {
            height: 6px;
            background-color: #333;
            border-radius: 3px;
            flex-grow: 1;
            margin-right: 10px;
            overflow: hidden;
        }
        
        .task-progress-fill {
            height: 100%;
            background-color: var(--tg-theme-button-color);
            border-radius: 3px;
        }
        
        .task-expiry {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
        }
        
        .task-button {
            width: 100%;
            padding: 10px;
            background: linear-gradient(145deg, var(--tg-theme-button-color), #0056b3);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .task-button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        /* √áekim talepleri tablosu */
        .withdrawals-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .withdrawals-table th, .withdrawals-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .withdrawals-table th {
            color: var(--tg-theme-hint-color);
            font-weight: 500;
        }
        
        .withdrawal-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--warning-color);
        }
        
        .status-completed {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }
        
        .status-failed {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }
        
        /* Bakƒ±m modu */
        .maintenance-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            text-align: center;
            padding: 20px;
        }
        
        .maintenance-content {
            max-width: 400px;
        }
        
        /* Yeni Kullanƒ±cƒ± Aray√ºz√º - 6 Buton */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .action-btn {
            padding: 20px 15px;
            background: linear-gradient(145deg, var(--tg-theme-button-color), #0056b3);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: transform 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
        }
        
        .action-btn .btn-icon {
            width: 32px;
            height: 32px;
        }
        
        .action-btn.watch-ad {
            background: linear-gradient(145deg, var(--success-color), #1e7e34);
        }
        
        .action-btn.withdraw {
            background: linear-gradient(145deg, #6f42c1, #5a2d91);
        }
        
        .action-btn.referrals {
            background: linear-gradient(145deg, #fd7e14, #e55a00);
        }
        
        .action-btn.tasks {
            background: linear-gradient(145deg, #20c997, #199d75);
        }
        
        .action-btn.leaderboard {
            background: linear-gradient(145deg, #e83e8c, #c2176c);
        }
        
        .action-btn.settings {
            background: linear-gradient(145deg, #6c757d, #545b62);
        }
        
        /* Kullanƒ±cƒ±lar tablosu */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .users-table th, .users-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .users-table th {
            color: var(--tg-theme-hint-color);
            font-weight: 500;
        }
        
        /* Sunucu ayarlarƒ± */
        .server-settings {
            text-align: left;
        }
        
        .setting-item {
            margin-bottom: 15px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .setting-item label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .setting-item input {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: #333;
            color: var(--tg-theme-text-color);
        }
    </style>
</head>
<body>
    <!-- Dil Se√ßimi Modalƒ± -->
    <div id="languageModal" class="language-modal">
        <div class="language-modal-content">
            <h2>Select Language / Dil Se√ßin</h2>
            <div class="language-options">
                <button class="language-option" data-lang="en">English</button>
                <button class="language-option" data-lang="tr">T√ºrk√ße</button>
                <button class="language-option" data-lang="ru">–†—É—Å—Å–∫–∏–π</button>
                <button class="language-option" data-lang="az">Az…ôrbaycanca</button>
                <button class="language-option" data-lang="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</button>
                <button class="language-option" data-lang="es">Espa√±ol</button>
            </div>
            <div class="language-confirm-section">
                <div class="language-confirm-checkbox">
                    <input type="checkbox" id="languageConfirm">
                    <label for="languageConfirm">I confirm my language selection / Dil se√ßimimi onaylƒ±yorum</label>
                </div>
                <button class="language-confirm-btn" id="languageConfirmBtn" disabled>Confirm / Onayla</button>
            </div>
        </div>
    </div>

    <!-- Bakƒ±m Modu -->
    <div id="maintenanceMode" class="maintenance-mode" style="display: none;">
        <div class="maintenance-content">
            <h2>üõ†Ô∏è Maintenance Mode</h2>
            <p>The app is currently under maintenance. Please try again later.</p>
            <p id="maintenanceMessage"></p>
        </div>
    </div>

    <div class="container">
        <!-- Home / Task View -->
        <div id="home-view" class="view">
            <div class="header"><h1>TorreAds</h1><p>Watch Ads and Earn TON</p></div>
            
            <!-- TON Price Chart -->
            <div class="price-chart">
                <div class="price-info">
                    <div class="current-price">TON: $<span id="tonPrice">0.00</span></div>
                    <div class="price-change" id="priceChange">0.00%</div>
                </div>
                <div class="chart-placeholder" id="chartPlaceholder">
                    Live TON Price Chart
                </div>
            </div>
            
            <div class="card">
                <h2>Current Balance</h2>
                <div class="balance-amount" id="balanceDisplay">TON 0.00</div>
                <div class="ad-info-grid">
                    <div class="ad-info-item"><h3 id="adCountDisplay">0</h3><p>Total Ads Watched</p></div>
                    <div class="ad-info-item"><h3 id="dailyAdCountDisplay">0 / 100</h3><p>Today's Ads</p></div>
                </div>
            </div>
            
            <!-- 6 Butonlu Aksiyon Men√ºs√º -->
            <div class="action-buttons">
                <button class="action-btn watch-ad" id="watchAdBtn">
                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.5 4.5l-15 7.5 15 7.5 1.5-0.75v-13.5l-1.5-0.75z"/>
                    </svg>
                    Watch Ad
                </button>
                <button class="action-btn withdraw" id="withdrawBtn">
                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.31 8.91a1 1 0 0 0-1.42 0l-4.24 4.24-2.12-2.12a1 1 0 1 0-1.42 1.42l2.83 2.83a1 1 0 0 0 1.42 0l5-5a1 1 0 0 0 0-1.42zM20 12a8 8 0 1 1-8-8 8 8 0 0 1 8 8zm-2 0a6 6 0 1 0-6 6 6 6 0 0 0 6-6z"/>
                    </svg>
                    Withdraw
                </button>
                <button class="action-btn referrals" id="referralsBtn">
                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V18h14v-1.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V18h6v-1.5c0-2.33-4.67-3.5-7-3.5z"/>
                    </svg>
                    Referrals
                </button>
                <button class="action-btn tasks" id="tasksBtn">
                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/>
                    </svg>
                    Tasks
                </button>
                <button class="action-btn leaderboard" id="leaderboardBtn">
                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7.5 21H2V9h5.5v12zm7.25-18h-5.5v18h5.5V3zM22 11h-5.5v10H22V11z"/>
                    </svg>
                    Leaderboard
                </button>
                <button class="action-btn settings" id="settingsBtn">
                    <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                    </svg>
                    Settings
                </button>
            </div>
            
            <!-- G√∂revler Pazarƒ± -->
            <div class="card" id="tasksCard" style="display: none;">
                <h2>Tasks Market</h2>
                <div class="tasks-container" id="tasksContainer">
                    <!-- G√∂revler burada dinamik olarak y√ºklenecek -->
                </div>
            </div>
            
            <!-- Yeni Admin Dashboard -->
            <div class="admin-dashboard" id="adminDashboard">
                <h3>üëë Admin Dashboard</h3>
                
                <div class="admin-nav">
                    <button class="admin-nav-btn" id="adminTasksBtn">G√∂rev Ekle</button>
                    <button class="admin-nav-btn" id="adminSettingsBtn">Sunucu Ayarlarƒ±</button>
                    <button class="admin-nav-btn" id="adminWithdrawalsBtn">√ñdeme Talepleri</button>
                    <button class="admin-nav-btn" id="adminUsersBtn">Kullanƒ±cƒ±lar</button>
                </div>
                
                <!-- G√∂rev Ekleme B√∂l√ºm√º -->
                <div class="admin-section" id="adminTasksSection">
                    <h4>Create New Task</h4>
                    <div class="input-group">
                        <label for="taskTitle">Task Title</label>
                        <input type="text" id="taskTitle" placeholder="Enter task title">
                    </div>
                    <div class="input-group">
                        <label for="taskDescription">Task Description</label>
                        <input type="text" id="taskDescription" placeholder="Enter task description">
                    </div>
                    <div class="input-group">
                        <label for="taskReward">Reward (TON)</label>
                        <input type="number" id="taskReward" step="0.001" min="0.001" value="0.004">
                    </div>
                    <div class="input-group">
                        <label for="taskMaxParticipants">Max Participants</label>
                        <input type="number" id="taskMaxParticipants" min="1" value="100">
                    </div>
                    <div class="input-group">
                        <label for="taskDuration">Duration (hours)</label>
                        <input type="number" id="taskDuration" min="1" value="48">
                    </div>
                    <div class="admin-controls">
                        <button class="admin-btn" id="submitTaskBtn">Create Task</button>
                    </div>
                </div>
                
                <!-- Sunucu Ayarlarƒ± B√∂l√ºm√º -->
                <div class="admin-section" id="adminSettingsSection">
                    <h4>Server Settings</h4>
                    <div class="server-settings">
                        <div class="setting-item">
                            <label for="maintenanceMode">Maintenance Mode</label>
                            <input type="checkbox" id="maintenanceModeToggle">
                        </div>
                        <div class="setting-item">
                            <label for="adReward">Ad Reward (TON)</label>
                            <input type="number" id="adReward" step="0.001" min="0.001" value="0.004">
                        </div>
                        <div class="setting-item">
                            <label for="withdrawThreshold">Withdraw Threshold (TON)</label>
                            <input type="number" id="withdrawThreshold" step="0.01" min="0.01" value="0.50">
                        </div>
                        <div class="setting-item">
                            <label for="dailyAdLimit">Daily Ad Limit</label>
                            <input type="number" id="dailyAdLimit" min="1" value="100">
                        </div>
                        <button class="admin-btn" id="saveSettingsBtn">Save Settings</button>
                    </div>
                </div>
                
                <!-- √ñdeme Talepleri B√∂l√ºm√º -->
                <div class="admin-section" id="adminWithdrawalsSection">
                    <h4>Withdrawal Requests</h4>
                    <table class="withdrawals-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Username</th>
                                <th>Amount</th>
                                <th>Address</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawalsTableBody">
                            <!-- √áekim talepleri burada g√∂r√ºnecek -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Kullanƒ±cƒ±lar B√∂l√ºm√º -->
                <div class="admin-section" id="adminUsersSection">
                    <h4>Users</h4>
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Username</th>
                                <th>Balance</th>
                                <th>Ads Watched</th>
                                <th>Referrals</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Kullanƒ±cƒ±lar burada g√∂r√ºnecek -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Withdraw View -->
        <div id="withdraw-view" class="view">
            <div class="header"><h1>Withdraw</h1><p>Request your earnings</p></div>
            <div class="card">
                <h2>Your Balance</h2>
                <div class="balance-amount" id="withdrawBalanceDisplay">TON 0.00</div>
                <p style="color: var(--tg-theme-hint-color); margin-top: 15px;">Minimum withdrawal is 0.50 TON.</p>
            </div>
            <div class="card">
                <h2>Payment Details</h2>
                <div class="input-group">
                    <label for="paymentAddress">Your TON Wallet Address</label>
                    <input type="text" id="paymentAddress" placeholder="e.g., EQ... (TON Address)">
                </div>
                <button class="btn" id="finalWithdrawBtn" disabled>Withdraw</button>
            </div>
        </div>
        
        <!-- Referral View -->
        <div id="referral-view" class="view">
            <div class="header"><h1>Referrals</h1><p>Invite friends and earn more!</p></div>
            <div class="card">
                <h2>Your Referral Stats</h2>
                <div class="ad-info-grid">
                    <div class="ad-info-item"><h3 id="referralCountDisplay">0</h3><p>Total Referrals</p></div>
                    <div class="ad-info-item"><h3 id="referralBonusDisplay">TON 0.00</h3><p>Referral Earnings</p></div>
                </div>
            </div>
            
            <!-- Manuel Referans Giri≈ü Kutusu -->
            <div class="card">
                <h2>Enter Referral Code</h2>
                <p>If someone referred you, enter their code here to get bonus!</p>
                <div class="referral-input-container">
                    <div class="referral-input-group">
                        <input type="text" id="referralCodeInput" placeholder="Enter referral code">
                        <button id="submitReferralBtn">Submit</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Your Referral Code</h2>
                <p>Share this code with your friends. You get 0.02 TON for each verified friend who joins!</p>
                <div class="referral-code-box" id="referralCodeBox" title="Click to copy">
                    <span id="userReferralCode">Loading...</span>
                </div>
                <p style="font-size:12px; color:var(--tg-theme-hint-color); margin-top:15px;">Click on the code above to copy it</p>
            </div>
        </div>

        <!-- Common Elements -->
        <div class="status-message" id="statusMessage"></div>
    </div>

    <!-- Footer Navigation -->
    <footer class="footer-nav">
        <button class="nav-btn active" id="navHome"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg></span><span>Home</span></button>
        <button class="nav-btn" id="navWithdraw"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.31 8.91a1 1 0 0 0-1.42 0l-4.24 4.24-2.12-2.12a1 1 0 1 0-1.42 1.42l2.83 2.83a1 1 0 0 0 1.42 0l5-5a1 1 0 0 0 0-1.42zM20 12a8 8 0 1 1-8-8 8 8 0 0 1 8 8zm-2 0a6 6 0 1 0-6 6 6 6 0 0 0 6-6z"/></svg></span><span>Withdraw</span></button>
        <button class="nav-btn" id="navRefer"><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V18h14v-1.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V18h6v-1.5c0-2.33-4.67-3.5-7-3.5z"/></svg></span><span>Referrals</span></button>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tg = window.Telegram.WebApp;

            // --- DOM Elements ---
            const balanceDisplay = document.getElementById('balanceDisplay'), 
                  adCountDisplay = document.getElementById('adCountDisplay'),
                  dailyAdCountDisplay = document.getElementById('dailyAdCountDisplay'), 
                  statusMessage = document.getElementById('statusMessage'),
                  withdrawBalanceDisplay = document.getElementById('withdrawBalanceDisplay'), 
                  paymentAddressInput = document.getElementById('paymentAddress'),
                  finalWithdrawBtn = document.getElementById('finalWithdrawBtn'), 
                  referralCountDisplay = document.getElementById('referralCountDisplay'), 
                  referralBonusDisplay = document.getElementById('referralBonusDisplay'), 
                  adminDashboard = document.getElementById('adminDashboard'), 
                  referralCodeInput = document.getElementById('referralCodeInput'), 
                  submitReferralBtn = document.getElementById('submitReferralBtn'), 
                  userReferralCodeDisplay = document.getElementById('userReferralCode'),
                  referralCodeBox = document.getElementById('referralCodeBox'), 
                  tonPriceDisplay = document.getElementById('tonPrice'), 
                  priceChangeDisplay = document.getElementById('priceChange'), 
                  chartPlaceholder = document.getElementById('chartPlaceholder'),
                  tasksContainer = document.getElementById('tasksContainer'),
                  languageModal = document.getElementById('languageModal'),
                  languageConfirm = document.getElementById('languageConfirm'),
                  languageConfirmBtn = document.getElementById('languageConfirmBtn'),
                  maintenanceMode = document.getElementById('maintenanceMode'),
                  maintenanceMessage = document.getElementById('maintenanceMessage'),
                  // Yeni butonlar
                  watchAdBtn = document.getElementById('watchAdBtn'),
                  withdrawBtn = document.getElementById('withdrawBtn'),
                  referralsBtn = document.getElementById('referralsBtn'),
                  tasksBtn = document.getElementById('tasksBtn'),
                  leaderboardBtn = document.getElementById('leaderboardBtn'),
                  settingsBtn = document.getElementById('settingsBtn'),
                  tasksCard = document.getElementById('tasksCard'),
                  // Admin butonlarƒ±
                  adminTasksBtn = document.getElementById('adminTasksBtn'),
                  adminSettingsBtn = document.getElementById('adminSettingsBtn'),
                  adminWithdrawalsBtn = document.getElementById('adminWithdrawalsBtn'),
                  adminUsersBtn = document.getElementById('adminUsersBtn'),
                  // Admin b√∂l√ºmleri
                  adminTasksSection = document.getElementById('adminTasksSection'),
                  adminSettingsSection = document.getElementById('adminSettingsSection'),
                  adminWithdrawalsSection = document.getElementById('adminWithdrawalsSection'),
                  adminUsersSection = document.getElementById('adminUsersSection'),
                  // Admin form elementleri
                  taskTitle = document.getElementById('taskTitle'),
                  taskDescription = document.getElementById('taskDescription'),
                  taskReward = document.getElementById('taskReward'),
                  taskMaxParticipants = document.getElementById('taskMaxParticipants'),
                  taskDuration = document.getElementById('taskDuration'),
                  submitTaskBtn = document.getElementById('submitTaskBtn'),
                  maintenanceModeToggle = document.getElementById('maintenanceModeToggle'),
                  adReward = document.getElementById('adReward'),
                  withdrawThreshold = document.getElementById('withdrawThreshold'),
                  dailyAdLimit = document.getElementById('dailyAdLimit'),
                  saveSettingsBtn = document.getElementById('saveSettingsBtn'),
                  withdrawalsTableBody = document.getElementById('withdrawalsTableBody'),
                  usersTableBody = document.getElementById('usersTableBody');

            // --- App Constants & Configuration ---
            const ADMIN_ID = 6357701459;
            const BOT_USERNAME = 'TorreAds_Bot';
            const WEBAPP_URL = 'https://torreads.onrender.com';
            const WITHDRAW_WEBHOOK_URL = 'https://eo3h4zf914hhqv7.m.pipedream.net';
            
            // JSONBin.io Configuration
            const JSONBIN_BIN_ID = '68dcfa1fae596e708f0235a7';
            const JSONBIN_API_KEY = '$2a$10$t0i.TuifzioNY0cd8HzoDOxB94YLcVc.gbHkv.qmFQzFJcbl9uVrK';
            const JSONBIN_BASE_URL = 'https://api.jsonbin.io/v3/b';
            
            const WITHDRAW_THRESHOLD = 0.50;
            const AD_REWARD_CENTS = 0.4; // 0.004 TON
            const REFERRAL_BONUS_TON = 0.02; // Referans olana 0.02 TON
            const REFERRER_BONUS_TON = 0.02; // Referans verene 0.02 TON
            const DAILY_AD_LIMIT = 100;

            // Dil √ßevirileri
            const translations = {
                en: {
                    appTitle: "TorreAds",
                    appSubtitle: "Watch Ads and Earn TON",
                    currentBalance: "Current Balance",
                    totalAdsWatched: "Total Ads Watched",
                    todaysAds: "Today's Ads",
                    watchAd: "Watch Ad",
                    withdraw: "Withdraw",
                    referrals: "Referrals",
                    tasks: "Tasks",
                    leaderboard: "Leaderboard",
                    settings: "Settings",
                    languageConfirm: "I confirm my language selection",
                    confirm: "Confirm"
                },
                tr: {
                    appTitle: "TorreAds",
                    appSubtitle: "Reklam ƒ∞zle ve TON Kazan",
                    currentBalance: "Mevcut Bakiye",
                    totalAdsWatched: "Toplam ƒ∞zlenen Reklam",
                    todaysAds: "Bug√ºnk√º Reklamlar",
                    watchAd: "Reklam ƒ∞zle",
                    withdraw: "√áekim Yap",
                    referrals: "Referanslar",
                    tasks: "G√∂revler",
                    leaderboard: "Lider Tablosu",
                    settings: "Ayarlar",
                    languageConfirm: "Dil se√ßimimi onaylƒ±yorum",
                    confirm: "Onayla"
                }
            };

            // --- Global Variables ---
            let userData = null;
            let globalData = null;
            let currentLanguage = 'en';
            let isAdmin = false;
            let maintenanceModeEnabled = false;
            let selectedLanguage = null;

            // --- Language Functions ---
            function setLanguage(lang) {
                currentLanguage = lang;
                localStorage.setItem('userLanguage', lang);
                updateUIWithTranslations();
            }

            function updateUIWithTranslations() {
                const t = translations[currentLanguage];
                
                // Ba≈ülƒ±klar
                document.querySelector('#home-view .header h1').textContent = t.appTitle;
                document.querySelector('#home-view .header p').textContent = t.appSubtitle;
                document.querySelector('#withdraw-view .header h1').textContent = t.withdraw;
                document.querySelector('#withdraw-view .header p').textContent = "Request your earnings";
                document.querySelector('#referral-view .header h1').textContent = t.referrals;
                document.querySelector('#referral-view .header p').textContent = "Invite friends and earn more!";
                
                // Ana sayfa
                document.querySelector('#home-view .card h2').textContent = t.currentBalance;
                document.querySelector('#home-view .ad-info-grid .ad-info-item:nth-child(1) p').textContent = t.totalAdsWatched;
                document.querySelector('#home-view .ad-info-grid .ad-info-item:nth-child(2) p').textContent = t.todaysAds;
                
                // Butonlar
                watchAdBtn.innerHTML = `<svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.5 4.5l-15 7.5 15 7.5 1.5-0.75v-13.5l-1.5-0.75z"/></svg>${t.watchAd}`;
                withdrawBtn.innerHTML = `<svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M17.31 8.91a1 1 0 0 0-1.42 0l-4.24 4.24-2.12-2.12a1 1 0 1 0-1.42 1.42l2.83 2.83a1 1 0 0 0 1.42 0l5-5a1 1 0 0 0 0-1.42zM20 12a8 8 0 1 1-8-8 8 8 0 0 1 8 8zm-2 0a6 6 0 1 0-6 6 6 6 0 0 0 6-6z"/></svg>${t.withdraw}`;
                referralsBtn.innerHTML = `<svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V18h14v-1.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V18h6v-1.5c0-2.33-4.67-3.5-7-3.5z"/></svg>${t.referrals}`;
                tasksBtn.innerHTML = `<svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-2 14l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>${t.tasks}`;
                leaderboardBtn.innerHTML = `<svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7.5 21H2V9h5.5v12zm7.25-18h-5.5v18h5.5V3zM22 11h-5.5v10H22V11z"/></svg>${t.leaderboard}`;
                settingsBtn.innerHTML = `<svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>${t.settings}`;
                
                // Navigasyon
                document.getElementById('navHome').querySelector('span:last-child').textContent = "Home";
                document.getElementById('navWithdraw').querySelector('span:last-child').textContent = t.withdraw;
                document.getElementById('navRefer').querySelector('span:last-child').textContent = t.referrals;
                
                // Dil onaylama
                document.querySelector('.language-confirm-checkbox label').textContent = t.languageConfirm;
                document.getElementById('languageConfirmBtn').textContent = t.confirm;
            }

            // --- Data Management Functions ---
            async function loadUserData() {
                try {
                    const userId = tg.initDataUnsafe.user?.id;
                    if (!userId) throw new Error('User ID not available');

                    // Global verileri y√ºkle
                    const globalResponse = await fetch(`${JSONBIN_BASE_URL}/${JSONBIN_BIN_ID}/latest`, {
                        headers: { 'X-Master-Key': JSONBIN_API_KEY }
                    });
                    
                    if (!globalResponse.ok) throw new Error('Failed to load global data');
                    const globalResult = await globalResponse.json();
                    globalData = globalResult.record || { users: {}, tasks: [], withdrawals: [], maintenance: false, globalStats: {}, settings: {} };
                    
                    // Bakƒ±m modunu kontrol et
                    maintenanceModeEnabled = globalData.maintenance || false;
                    if (maintenanceModeEnabled) {
                        showMaintenanceMode();
                        return;
                    }
                    
                    // Kullanƒ±cƒ± verilerini y√ºkle veya olu≈ütur
                    if (!globalData.users[userId]) {
                        userData = {
                            balance: 0,
                            totalAds: 0,
                            dailyAds: 0,
                            lastAdDate: new Date().toDateString(),
                            referralCount: 0,
                            referralBonus: 0,
                            referralCode: generateReferralCode(),
                            referredBy: null,
                            completedTasks: []
                        };
                        globalData.users[userId] = userData;
                        await saveGlobalData();
                    } else {
                        userData = globalData.users[userId];
                        
                        // G√ºnl√ºk reklam sƒ±fƒ±rlama kontrol√º
                        const today = new Date().toDateString();
                        if (userData.lastAdDate !== today) {
                            userData.dailyAds = 0;
                            userData.lastAdDate = today;
                            await saveGlobalData();
                        }
                    }
                    
                    // Admin kontrol√º
                    isAdmin = userId === ADMIN_ID;
                    if (isAdmin) {
                        adminDashboard.style.display = 'block';
                        loadAdminData();
                    }
                    
                    updateUI();
                    loadTasks();
                    
                } catch (error) {
                    console.error('Error loading user data:', error);
                    showStatus('Failed to load data. Please try again.', 'error');
                }
            }

            async function saveGlobalData() {
                try {
                    const response = await fetch(`${JSONBIN_BASE_URL}/${JSONBIN_BIN_ID}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_API_KEY
                        },
                        body: JSON.stringify(globalData)
                    });
                    
                    if (!response.ok) throw new Error('Failed to save data');
                } catch (error) {
                    console.error('Error saving data:', error);
                    throw error;
                }
            }

            function generateReferralCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            // --- UI Update Functions ---
            function updateUI() {
                if (!userData) return;
                
                // Ana sayfa g√ºncelleme
                balanceDisplay.textContent = `TON ${userData.balance.toFixed(3)}`;
                adCountDisplay.textContent = userData.totalAds;
                dailyAdCountDisplay.textContent = `${userData.dailyAds} / ${DAILY_AD_LIMIT}`;
                
                // √áekim sayfasƒ± g√ºncelleme
                withdrawBalanceDisplay.textContent = `TON ${userData.balance.toFixed(3)}`;
                
                // Referans sayfasƒ± g√ºncelleme
                referralCountDisplay.textContent = userData.referralCount;
                referralBonusDisplay.textContent = `TON ${userData.referralBonus.toFixed(3)}`;
                userReferralCodeDisplay.textContent = userData.referralCode;
                
                // √áekim butonunu g√ºncelle
                updateWithdrawButton();
            }

            function updateWithdrawButton() {
                if (userData.balance >= WITHDRAW_THRESHOLD && paymentAddressInput.value.trim()) {
                    finalWithdrawBtn.disabled = false;
                } else {
                    finalWithdrawBtn.disabled = true;
                }
            }

            // --- Status Message Functions ---
            function showStatus(message, type = 'info') {
                statusMessage.textContent = message;
                statusMessage.className = `status-message ${type}`;
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }

            // --- Navigation Functions ---
            function showView(viewId) {
                document.querySelectorAll('.view').forEach(view => {
                    view.style.display = 'none';
                });
                document.getElementById(viewId).style.display = 'block';
                
                // Navigasyon butonlarƒ±nƒ± g√ºncelle
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (viewId === 'home-view') {
                    document.getElementById('navHome').classList.add('active');
                } else if (viewId === 'withdraw-view') {
                    document.getElementById('navWithdraw').classList.add('active');
                    updateWithdrawButton();
                } else if (viewId === 'referral-view') {
                    document.getElementById('navRefer').classList.add('active');
                }
            }

            // --- Event Listeners ---
            document.getElementById('navHome').addEventListener('click', () => showView('home-view'));
            document.getElementById('navWithdraw').addEventListener('click', () => showView('withdraw-view'));
            document.getElementById('navRefer').addEventListener('click', () => showView('referral-view'));

            // Yeni buton event listener'larƒ±
            watchAdBtn.addEventListener('click', async () => {
                if (!userData) return;
                
                if (userData.dailyAds >= DAILY_AD_LIMIT) {
                    showStatus('Daily ad limit reached. Try again tomorrow.', 'error');
                    return;
                }
                
                watchAdBtn.classList.add('btn-loading');
                
                try {
                    // Gigapub reklam g√∂sterimi
                    if (typeof window.showGiga === 'function') {
                        await new Promise((resolve, reject) => {
                            window.showGiga({
                                placementId: '986',
                                onReward: resolve,
                                onClose: resolve,
                                onError: reject
                            });
                        });
                    } else {
                        // Fallback: Manuel √∂d√ºl
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                    
                    // Ba≈üarƒ±lƒ± reklam izleme
                    userData.balance += AD_REWARD_CENTS;
                    userData.totalAds++;
                    userData.dailyAds++;
                    
                    // Global istatistikleri g√ºncelle
                    if (!globalData.globalStats) globalData.globalStats = {};
                    globalData.globalStats.totalAds = (globalData.globalStats.totalAds || 0) + 1;
                    globalData.globalStats.totalTON = (globalData.globalStats.totalTON || 0) + AD_REWARD_CENTS;
                    
                    await saveGlobalData();
                    updateUI();
                    
                    showStatus(`Success! You earned ${AD_REWARD_CENTS} TON.`, 'success');
                    
                } catch (error) {
                    console.error('Error showing ad:', error);
                    showStatus('Failed to show ad. Please try again.', 'error');
                } finally {
                    watchAdBtn.classList.remove('btn-loading');
                }
            });

            withdrawBtn.addEventListener('click', () => {
                showView('withdraw-view');
            });

            referralsBtn.addEventListener('click', () => {
                showView('referral-view');
            });

            tasksBtn.addEventListener('click', () => {
                tasksCard.style.display = tasksCard.style.display === 'none' ? 'block' : 'none';
            });

            leaderboardBtn.addEventListener('click', () => {
                showStatus('Leaderboard feature coming soon!', 'info');
            });

            settingsBtn.addEventListener('click', () => {
                showStatus('Settings feature coming soon!', 'info');
            });

            // Dil se√ßimi event listener'larƒ±
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', function() {
                    // T√ºm se√ßeneklerden se√ßili sƒ±nƒ±fƒ±nƒ± kaldƒ±r
                    document.querySelectorAll('.language-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // Bu se√ßeneƒüi se√ßili yap
                    this.classList.add('selected');
                    selectedLanguage = this.getAttribute('data-lang');
                });
            });

            // Dil onaylama checkbox'ƒ±
            languageConfirm.addEventListener('change', function() {
                languageConfirmBtn.disabled = !this.checked;
            });

            // Dil onaylama butonu
            languageConfirmBtn.addEventListener('click', function() {
                if (selectedLanguage) {
                    setLanguage(selectedLanguage);
                    languageModal.style.display = 'none';
                    showStatus('Language changed successfully!', 'success');
                }
            });

            // √áekim adresi giri≈üi
            paymentAddressInput.addEventListener('input', updateWithdrawButton);

            // √áekim butonu
            finalWithdrawBtn.addEventListener('click', async () => {
                if (!userData || userData.balance < WITHDRAW_THRESHOLD) {
                    showStatus(`Minimum withdrawal is ${WITHDRAW_THRESHOLD} TON.`, 'error');
                    return;
                }
                
                const address = paymentAddressInput.value.trim();
                if (!address) {
                    showStatus('Please enter a valid TON wallet address.', 'error');
                    return;
                }
                
                finalWithdrawBtn.classList.add('btn-loading');
                
                try {
                    const userId = tg.initDataUnsafe.user?.id;
                    const username = tg.initDataUnsafe.user?.username || 'Unknown';
                    const amount = userData.balance;
                    
                    // √áekim talebini olu≈ütur
                    const withdrawal = {
                        userId: userId,
                        username: username,
                        amount: amount,
                        address: address,
                        status: 'pending',
                        timestamp: new Date().toISOString()
                    };
                    
                    if (!globalData.withdrawals) globalData.withdrawals = [];
                    globalData.withdrawals.push(withdrawal);
                    
                    // Kullanƒ±cƒ± bakiyesini sƒ±fƒ±rla
                    userData.balance = 0;
                    
                    await saveGlobalData();
                    updateUI();
                    
                    // Webhook'a √ßekim talebini g√∂nder
                    await fetch(WITHDRAW_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(withdrawal)
                    });
                    
                    showStatus(`Withdrawal request for ${amount.toFixed(3)} TON submitted successfully!`, 'success');
                    paymentAddressInput.value = '';
                    
                } catch (error) {
                    console.error('Error processing withdrawal:', error);
                    showStatus('Failed to process withdrawal. Please try again.', 'error');
                } finally {
                    finalWithdrawBtn.classList.remove('btn-loading');
                }
            });

            // Referans kodunu kopyalama
            referralCodeBox.addEventListener('click', () => {
                navigator.clipboard.writeText(userData.referralCode).then(() => {
                    showStatus('Referral code copied to clipboard!', 'success');
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    showStatus('Failed to copy referral code.', 'error');
                });
            });

            // Referans kodunu g√∂nderme
            submitReferralBtn.addEventListener('click', async () => {
                const code = referralCodeInput.value.trim().toUpperCase();
                if (!code) {
                    showStatus('Please enter a referral code.', 'error');
                    return;
                }
                
                if (userData.referredBy) {
                    showStatus('You have already used a referral code.', 'error');
                    return;
                }
                
                // Kullanƒ±cƒ± kendi kodunu giremez
                if (code === userData.referralCode) {
                    showStatus('You cannot use your own referral code.', 'error');
                    return;
                }
                
                submitReferralBtn.classList.add('btn-loading');
                
                try {
                    // Referans koduna sahip kullanƒ±cƒ±yƒ± bul
                    let referrer = null;
                    for (const userId in globalData.users) {
                        if (globalData.users[userId].referralCode === code) {
                            referrer = globalData.users[userId];
                            break;
                        }
                    }
                    
                    if (!referrer) {
                        showStatus('Invalid referral code.', 'error');
                        return;
                    }
                    
                    // Referans i≈ülemini kaydet
                    userData.referredBy = code;
                    referrer.referralCount = (referrer.referralCount || 0) + 1;
                    referrer.referralBonus = (referrer.referralBonus || 0) + REFERRER_BONUS_TON;
                    referrer.balance = (referrer.balance || 0) + REFERRER_BONUS_TON;
                    
                    // Referans olan kullanƒ±cƒ±ya da bonus ver
                    userData.balance += REFERRAL_BONUS_TON;
                    
                    await saveGlobalData();
                    updateUI();
                    
                    showStatus(`Success! You received ${REFERRAL_BONUS_TON} TON bonus.`, 'success');
                    referralCodeInput.value = '';
                    
                } catch (error) {
                    console.error('Error applying referral code:', error);
                    showStatus('Failed to apply referral code. Please try again.', 'error');
                } finally {
                    submitReferralBtn.classList.remove('btn-loading');
                }
            });

            // TON fiyatƒ±nƒ± g√ºncelleme
            async function updateTONPrice() {
                try {
                    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd&include_24hr_change=true');
                    const data = await response.json();
                    
                    if (data['the-open-network']) {
                        const price = data['the-open-network'].usd;
                        const change = data['the-open-network'].usd_24h_change;
                        
                        tonPriceDisplay.textContent = price.toFixed(2);
                        
                        if (change > 0) {
                            priceChangeDisplay.textContent = `+${change.toFixed(2)}%`;
                            priceChangeDisplay.className = 'price-change positive';
                        } else {
                            priceChangeDisplay.textContent = `${change.toFixed(2)}%`;
                            priceChangeDisplay.className = 'price-change negative';
                        }
                    }
                } catch (error) {
                    console.error('Error fetching TON price:', error);
                }
            }

            // --- Admin Functions ---
            function loadAdminData() {
                // Admin ayarlarƒ±nƒ± y√ºkle
                if (globalData.settings) {
                    maintenanceModeToggle.checked = globalData.settings.maintenance || false;
                    adReward.value = globalData.settings.adReward || AD_REWARD_CENTS;
                    withdrawThreshold.value = globalData.settings.withdrawThreshold || WITHDRAW_THRESHOLD;
                    dailyAdLimit.value = globalData.settings.dailyAdLimit || DAILY_AD_LIMIT;
                }
                
                // √áekim taleplerini y√ºkle
                loadWithdrawalsTable();
                
                // Kullanƒ±cƒ±larƒ± y√ºkle
                loadUsersTable();
            }

            // Admin navigasyon butonlarƒ±
            adminTasksBtn.addEventListener('click', () => {
                showAdminSection('adminTasksSection');
            });

            adminSettingsBtn.addEventListener('click', () => {
                showAdminSection('adminSettingsSection');
            });

            adminWithdrawalsBtn.addEventListener('click', () => {
                showAdminSection('adminWithdrawalsSection');
            });

            adminUsersBtn.addEventListener('click', () => {
                showAdminSection('adminUsersSection');
            });

            function showAdminSection(sectionId) {
                // T√ºm b√∂l√ºmleri gizle
                document.querySelectorAll('.admin-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Se√ßilen b√∂l√ºm√º g√∂ster
                document.getElementById(sectionId).classList.add('active');
            }

            // G√∂rev olu≈üturma
            submitTaskBtn.addEventListener('click', async () => {
                if (!isAdmin) return;
                
                const title = taskTitle.value.trim();
                const description = taskDescription.value.trim();
                const reward = parseFloat(taskReward.value);
                const maxParticipants = parseInt(taskMaxParticipants.value);
                const duration = parseInt(taskDuration.value);
                
                if (!title || !description || isNaN(reward) || isNaN(maxParticipants) || isNaN(duration)) {
                    showStatus('Please fill all fields with valid values.', 'error');
                    return;
                }
                
                if (reward <= 0) {
                    showStatus('Reward must be greater than 0.', 'error');
                    return;
                }
                
                try {
                    const task = {
                        id: Date.now().toString(),
                        title: title,
                        description: description,
                        reward: reward,
                        maxParticipants: maxParticipants,
                        currentParticipants: 0,
                        duration: duration, // hours
                        createdAt: new Date().toISOString(),
                        participants: [],
                        status: 'active'
                    };
                    
                    if (!globalData.tasks) globalData.tasks = [];
                    globalData.tasks.push(task);
                    
                    await saveGlobalData();
                    loadTasks();
                    
                    taskTitle.value = '';
                    taskDescription.value = '';
                    taskReward.value = '0.004';
                    taskMaxParticipants.value = '100';
                    taskDuration.value = '48';
                    
                    showStatus('Task created successfully!', 'success');
                } catch (error) {
                    console.error('Error creating task:', error);
                    showStatus('Failed to create task.', 'error');
                }
            });

            // Ayarlarƒ± kaydet
            saveSettingsBtn.addEventListener('click', async () => {
                if (!isAdmin) return;
                
                try {
                    if (!globalData.settings) globalData.settings = {};
                    
                    globalData.settings.maintenance = maintenanceModeToggle.checked;
                    globalData.settings.adReward = parseFloat(adReward.value);
                    globalData.settings.withdrawThreshold = parseFloat(withdrawThreshold.value);
                    globalData.settings.dailyAdLimit = parseInt(dailyAdLimit.value);
                    
                    globalData.maintenance = maintenanceModeToggle.checked;
                    
                    await saveGlobalData();
                    
                    showStatus('Settings saved successfully!', 'success');
                } catch (error) {
                    console.error('Error saving settings:', error);
                    showStatus('Failed to save settings.', 'error');
                }
            });

            // √áekim taleplerini y√ºkle
            function loadWithdrawalsTable() {
                if (!globalData.withdrawals || !isAdmin) return;
                
                withdrawalsTableBody.innerHTML = '';
                
                globalData.withdrawals.forEach((withdrawal, index) => {
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${withdrawal.userId}</td>
                        <td>${withdrawal.username}</td>
                        <td>${withdrawal.amount.toFixed(3)} TON</td>
                        <td>${withdrawal.address}</td>
                        <td><span class="withdrawal-status status-${withdrawal.status}">${withdrawal.status}</span></td>
                        <td>
                            ${withdrawal.status === 'pending' ? 
                                `<button class="admin-btn" onclick="approveWithdrawal(${index})">Approve</button>
                                 <button class="admin-btn danger" onclick="rejectWithdrawal(${index})">Reject</button>` : 
                                ''}
                        </td>
                    `;
                    
                    withdrawalsTableBody.appendChild(row);
                });
            }

            // Kullanƒ±cƒ±larƒ± y√ºkle
            function loadUsersTable() {
                if (!globalData.users || !isAdmin) return;
                
                usersTableBody.innerHTML = '';
                
                let userCount = 0;
                for (const userId in globalData.users) {
                    if (userCount >= 50) break; // ƒ∞lk 50 kullanƒ±cƒ±yƒ± g√∂ster
                    
                    const user = globalData.users[userId];
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${userId}</td>
                        <td>${user.username || 'N/A'}</td>
                        <td>${user.balance.toFixed(3)} TON</td>
                        <td>${user.totalAds || 0}</td>
                        <td>${user.referralCount || 0}</td>
                    `;
                    
                    usersTableBody.appendChild(row);
                    userCount++;
                }
            }

            // √áekim talebini onayla (global fonksiyon)
            window.approveWithdrawal = async function(index) {
                if (!isAdmin) return;
                
                try {
                    globalData.withdrawals[index].status = 'completed';
                    await saveGlobalData();
                    loadWithdrawalsTable();
                    showStatus('Withdrawal approved.', 'success');
                } catch (error) {
                    console.error('Error approving withdrawal:', error);
                    showStatus('Failed to approve withdrawal.', 'error');
                }
            };

            // √áekim talebini reddet (global fonksiyon)
            window.rejectWithdrawal = async function(index) {
                if (!isAdmin) return;
                
                try {
                    globalData.withdrawals[index].status = 'failed';
                    
                    // Bakiyeyi kullanƒ±cƒ±ya iade et
                    const withdrawal = globalData.withdrawals[index];
                    if (globalData.users[withdrawal.userId]) {
                        globalData.users[withdrawal.userId].balance += withdrawal.amount;
                    }
                    
                    await saveGlobalData();
                    loadWithdrawalsTable();
                    showStatus('Withdrawal rejected.', 'success');
                } catch (error) {
                    console.error('Error rejecting withdrawal:', error);
                    showStatus('Failed to reject withdrawal.', 'error');
                }
            };

            // G√∂revleri y√ºkle
            function loadTasks() {
                if (!globalData.tasks || !userData) return;
                
                tasksContainer.innerHTML = '';
                
                const now = new Date();
                const activeTasks = globalData.tasks.filter(task => {
                    if (task.status !== 'active') return false;
                    
                    const createdAt = new Date(task.createdAt);
                    const expiryTime = new Date(createdAt.getTime() + task.duration * 60 * 60 * 1000);
                    
                    // S√ºresi dolmu≈ü g√∂revleri kapat
                    if (now > expiryTime) {
                        task.status = 'expired';
                        return false;
                    }
                    
                    // Kotasƒ± dolmu≈ü g√∂revleri kapat
                    if (task.currentParticipants >= task.maxParticipants) {
                        task.status = 'completed';
                        return false;
                    }
                    
                    return true;
                });
                
                if (activeTasks.length === 0) {
                    tasksContainer.innerHTML = '<p style="text-align: center; color: var(--tg-theme-hint-color);">No active tasks available.</p>';
                    return;
                }
                
                activeTasks.forEach(task => {
                    const taskCard = document.createElement('div');
                    taskCard.className = 'task-card';
                    
                    const createdAt = new Date(task.createdAt);
                    const expiryTime = new Date(createdAt.getTime() + task.duration * 60 * 60 * 1000);
                    const timeLeft = Math.max(0, expiryTime - now);
                    const hoursLeft = Math.floor(timeLeft / (60 * 60 * 1000));
                    const minutesLeft = Math.floor((timeLeft % (60 * 60 * 1000)) / (60 * 1000));
                    
                    const progressPercent = (task.currentParticipants / task.maxParticipants) * 100;
                    
                    const hasParticipated = userData.completedTasks && userData.completedTasks.includes(task.id);
                    
                    taskCard.innerHTML = `
                        <div class="task-header">
                            <div class="task-title">${task.title}</div>
                            <div class="task-reward">+${task.reward.toFixed(3)} TON</div>
                        </div>
                        <div class="task-description">${task.description}</div>
                        <div class="task-progress">
                            <div class="task-progress-bar">
                                <div class="task-progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <div>${task.currentParticipants}/${task.maxParticipants}</div>
                        </div>
                        <div class="task-expiry">Time left: ${hoursLeft}h ${minutesLeft}m</div>
                        <button class="task-button" ${hasParticipated ? 'disabled' : ''} 
                                onclick="completeTask('${task.id}')">
                            ${hasParticipated ? 'Completed' : 'Start Task'}
                        </button>
                    `;
                    
                    tasksContainer.appendChild(taskCard);
                });
            }

            // G√∂revi tamamla (global fonksiyon)
            window.completeTask = async function(taskId) {
                if (!userData) return;
                
                try {
                    const task = globalData.tasks.find(t => t.id === taskId);
                    if (!task || task.status !== 'active') {
                        showStatus('Task not available.', 'error');
                        return;
                    }
                    
                    // Kullanƒ±cƒ± zaten bu g√∂revi tamamlamƒ±≈ü mƒ±?
                    if (userData.completedTasks && userData.completedTasks.includes(taskId)) {
                        showStatus('You have already completed this task.', 'error');
                        return;
                    }
                    
                    // G√∂rev kotasƒ± dolmu≈ü mu?
                    if (task.currentParticipants >= task.maxParticipants) {
                        task.status = 'completed';
                        await saveGlobalData();
                        showStatus('This task is no longer available.', 'error');
                        loadTasks();
                        return;
                    }
                    
                    // G√∂revi tamamla
                    userData.balance += task.reward;
                    task.currentParticipants += 1;
                    
                    if (!userData.completedTasks) userData.completedTasks = [];
                    userData.completedTasks.push(taskId);
                    
                    if (!task.participants) task.participants = [];
                    task.participants.push({
                        userId: tg.initDataUnsafe.user?.id,
                        username: tg.initDataUnsafe.user?.username || 'Unknown',
                        completedAt: new Date().toISOString()
                    });
                    
                    // Kotasƒ± doldu mu?
                    if (task.currentParticipants >= task.maxParticipants) {
                        task.status = 'completed';
                    }
                    
                    await saveGlobalData();
                    updateUI();
                    loadTasks();
                    
                    showStatus(`Task completed! You earned ${task.reward.toFixed(3)} TON.`, 'success');
                } catch (error) {
                    console.error('Error completing task:', error);
                    showStatus('Failed to complete task.', 'error');
                }
            };

            // Bakƒ±m modunu g√∂ster
            function showMaintenanceMode() {
                maintenanceMode.style.display = 'flex';
                document.querySelector('.container').style.display = 'none';
                document.querySelector('.footer-nav').style.display = 'none';
            }

            // --- App Initialization ---
            async function initApp() {
                // Telegram Web App'ƒ± geni≈ület
                tg.expand();
                
                // Dil ayarƒ±nƒ± y√ºkle
                const savedLanguage = localStorage.getItem('userLanguage');
                if (savedLanguage && translations[savedLanguage]) {
                    setLanguage(savedLanguage);
                } else {
                    // Varsayƒ±lan dil se√ßimi modalƒ±nƒ± g√∂ster
                    languageModal.style.display = 'flex';
                }
                
                // TON fiyatƒ±nƒ± g√ºncelle
                updateTONPrice();
                setInterval(updateTONPrice, 60000); // Her dakika g√ºncelle
                
                // Kullanƒ±cƒ± verilerini y√ºkle
                await loadUserData();
            }

            // Uygulamayƒ± ba≈ülat
            initApp();
        });
    </script>
</body>
</html>
