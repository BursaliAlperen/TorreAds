<!DOCTYPE html>
<html lang="tr">
<head>
    <script src='//libtl.com/sdk.js' data-zone='9441902'></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ðŸŽ¬ Reklam Ä°zle, Ã–dÃ¼l Kazan</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background: #f9f9f9;
        }
        .balance {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #1a73e8;
        }
        button {
            padding: 12px 25px;
            font-size: 1.2rem;
            border: none;
            border-radius: 10px;
            background-color: #1a73e8;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:disabled {
            background-color: #a0c3f0;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
            height: 1.5em;
        }
        .message-success {
            color: green;
        }
        .message-error {
            color: red;
        }
    </style>
</head>
<body>

<div class="balance">Bakiyeniz: <span id="balance">0.0000</span> TON</div>
<button id="watchAdBtn" disabled>Reklam YÃ¼kleniyor...</button>
<div id="status"></div>

<script>
  const API_REWARD = 'http://127.0.0.1:5001/api/reward';
  const API_BALANCE = 'http://127.0.0.1:5001/api/balance';
  const REWARD_AMOUNT = 0.0001;

  const btn = document.getElementById('watchAdBtn');
  const status = document.getElementById('status');
  const balanceDisplay = document.getElementById('balance');

  function getToken() {
    let token = localStorage.getItem('user_token');
    if (!token) {
      token = crypto.randomUUID();
      localStorage.setItem('user_token', token);
    }
    return token;
  }

  async function fetchBalance() {
    const token = getToken();
    try {
      const res = await fetch(`${API_BALANCE}?token=${token}`);
      const data = await res.json();
      if (data.success) {
        updateBalance(data.balance);
      }
    } catch {
      status.textContent = "Bakiyeniz yÃ¼klenemedi.";
    }
  }

  function updateBalance(amount) {
    balanceDisplay.textContent = amount.toFixed(4);
    localStorage.setItem('user_balance', amount);
  }

  function enableButton() {
    btn.disabled = false;
    btn.textContent = 'ðŸŽ¥ ReklamÄ± Ä°zle';
    status.textContent = 'Reklam hazÄ±r. Ä°zlemek iÃ§in tÄ±klayÄ±n.';
  }

  function disableButton(msg) {
    btn.disabled = true;
    btn.textContent = msg || 'YÃ¼kleniyor...';
  }

  async function waitForSDK(retries = 20, delay = 500) {
    for (let i = 0; i < retries; i++) {
      if (typeof show_9441902 === 'function') return;
      await new Promise(r => setTimeout(r, delay));
    }
    throw new Error('Reklam SDK yÃ¼klenemedi.');
  }

  btn.addEventListener('click', async () => {
    disableButton('Reklam baÅŸlatÄ±lÄ±yor...');
    status.textContent = '';

    try {
      await waitForSDK();
      await show_9441902();

      status.textContent = `ðŸŽ‰ ${REWARD_AMOUNT} TON kazandÄ±nÄ±z! Bakiyenize ekleniyor...`;
      
      const token = getToken();
      const res = await fetch(API_REWARD, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ token }),
      });
      const result = await res.json();

      if (res.ok && result.success) {
        updateBalance(result.balance);
        status.textContent = `âœ… Ã–dÃ¼l baÅŸarÄ±yla eklendi. Yeni bakiye: ${result.balance.toFixed(4)} TON`;
        status.className = 'message-success';
      } else {
        status.textContent = result.message || 'Ã–dÃ¼l verilemedi.';
        status.className = 'message-error';
      }

    } catch (err) {
      console.error(err);
      status.textContent = err.message || 'Reklam gÃ¶sterilemedi veya erken kapatÄ±ldÄ±.';
      status.className = 'message-error';
    } finally {
      enableButton();
    }
  });

  // Sayfa yÃ¼klendiÄŸinde bakiye getir ve butonu aktif et
  window.addEventListener('load', async () => {
    try {
      await waitForSDK();
      enableButton();
      await fetchBalance();
    } catch (err) {
      status.textContent = err.message;
      status.className = 'message-error';
    }
  });
</script>

</body>
</html>
