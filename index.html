<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ton Withdraw & Ads App</title>

  <!-- GigaPub Reklam Scripti -->
  <script src="https://ad.gigapub.tech/script?id=986"></script>

  <!-- Google font + FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --accent:#0a84ff; --muted:#666; --success:#1db954;
    }
    *{box-sizing:border-box}
    body{font-family:"Nunito",sans-serif;margin:0;background:var(--bg);color:#111}
    #app{max-width:520px;margin:0 auto;padding-bottom:80px}
    header{display:flex;align-items:center;padding:18px;border-bottom:1px solid #e6eaf0;background:var(--card)}
    #user-photo{width:56px;height:56px;border-radius:50%;object-fit:cover;margin-right:12px;border:2px solid var(--accent)}
    h1{font-size:1.1rem;margin:0}
    p.sub{margin:4px 0 0;color:var(--muted);font-weight:600}
    main{padding:16px}
    .grid{display:grid;gap:12px}
    .card{background:var(--card);padding:14px;border-radius:12px;border:1px solid #e6eaf0}
    .stat{display:flex;justify-content:space-between;align-items:center}
    .big{font-size:1.35rem;font-weight:700;color:var(--accent)}
    #referral-link{flex:1;padding:10px;border-radius:8px;border:1px dashed #cfd8e3;background:#fafbff;font-size:0.9rem}
    button.btn{padding:12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .task{display:flex;flex-direction:column;gap:10px}
    .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:var(--card);max-width:520px;margin:0 auto;display:flex;justify-content:space-around;padding:10px;border-top:1px solid #e6eaf0}
    .nav-btn{background:transparent;border:0;display:flex;flex-direction:column;align-items:center;font-size:12px;color:var(--muted);cursor:pointer}
    .nav-btn.active{color:var(--accent);font-weight:700}
    form .form-group{margin-bottom:12px}
    label{display:block;font-weight:700;margin-bottom:6px}
    input, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eaf0;background:#fff}
    .note{font-size:0.9rem;color:#333;background:#fff;padding:10px;border-radius:8px;border:1px solid #f0f0f0}
    .loader{width:18px;height:18px;border:3px solid rgba(255,255,255,0.4);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;display:inline-block}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div id="app" class="card">
    <header>
      <img id="user-photo" src="https://i.imgur.com/placeholder.png" alt="user">
      <div>
        <h1 id="user-name">Yükleniyor... <i class="fas fa-check-circle" style="color:var(--accent);margin-left:6px"></i></h1>
        <p class="sub"> Balance: $<span id="user-balance">0.00</span></p>
      </div>
    </header>

    <main id="main-content">
      <!-- Dashboard -->
      <section id="home-page" class="page">
        <h2>Kontrol Paneli</h2>
        <div class="grid">
          <div class="card stat">
            <div><div class="big" id="daily-ads-watched">0</div><div class="small">Günlük Reklam</div></div>
            <div><div class="big" id="referral-count">0</div><div class="small">Referrals</div></div>
          </div>
          <div class="card">
            <div style="display:flex;gap:8px;align-items:center">
              <input id="referral-link" readonly value="">
              <button id="copy-ref-link-btn" class="btn">Kopyala</button>
            </div>
            <p style="font-size:0.9rem;margin-top:6px">Her referans için $0.02 kazanırsınız.</p>
          </div>
        </div>
      </section>

      <!-- Tasks -->
      <section id="tasks-page" class="page" style="display:none">
        <h2>Görevler</h2>
        <div class="card task">
          <div><strong>Reklam İzle</strong> – $0.25 kazan</div>
          <button id="watch-ad-btn" class="btn">Reklam İzle</button>
        </div>
        <div class="card task">
          <div><strong>Join Kanal / Grup</strong></div>
          <a href="https://t.me/Torrelabs" target="_blank" class="btn">Kanal</a>
          <a href="https://t.me/torreAdsChat" target="_blank" class="btn">Grup</a>
        </div>
      </section>

      <!-- Withdraw -->
      <section id="withdraw-page" class="page" style="display:none">
        <h2>Withdraw (TON)</h2>
        <form id="withdraw-form" class="card">
          <div class="form-group">
            <label for="withdraw-amount">Tutar ($)</label>
            <input type="number" id="withdraw-amount" step="0.01" required>
          </div>
          <div class="form-group">
            <label for="ton-address">TON Adresi</label>
            <input type="text" id="ton-address" required>
          </div>
          <div class="note" id="ton-warning">Güncel TON fiyatı alınıyor...</div>
          <button id="withdraw-submit-btn" class="btn" type="submit">Çekim İsteği Gönder</button>
        </form>
      </section>
    </main>

    <nav class="bottom-nav">
      <button class="nav-btn active" data-page="home-page"><i class="fas fa-home"></i>Home</button>
      <button class="nav-btn" data-page="tasks-page"><i class="fas fa-play"></i>Görev</button>
      <button class="nav-btn" data-page="withdraw-page"><i class="fas fa-wallet"></i>Withdraw</button>
    </nav>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
  (function(){
    const PIPEDREAM_ENDPOINT = "https://eo3h4zf914hhqv7.m.pipedream.net";
    const JSONBIN_API_KEY = "$2a$10$KD.7qzKquuA6yJbLsBORROtwmYc/e8dVxXzczpiSFvypxIU9nai9G";
    const JSONBIN_BIN_ID = "68da76fad0ea881f408f1248";
    const REF_REWARD_USD = 0.02, AD_REWARD_USD = 0.25, MIN_WITHDRAW_USD = 0.02;
    const PRICE_URL = "https://api.coingecko.com/api/v3/simple/price?ids=toncoin&vs_currencies=usd";

    const tg = window.Telegram.WebApp || {initDataUnsafe:{}, ready:()=>{}};
    let userState = { balance_usd:0, referrals:[], dailyAds:0, userId:null };

    const balEl=document.getElementById('user-balance'),
          refCount=document.getElementById('referral-count'),
          refLink=document.getElementById('referral-link'),
          watchAdBtn=document.getElementById('watch-ad-btn'),
          withdrawForm=document.getElementById('withdraw-form'),
          withdrawAmt=document.getElementById('withdraw-amount'),
          tonAddr=document.getElementById('ton-address'),
          tonWarn=document.getElementById('ton-warning');

    function updateUI(){
      balEl.textContent = userState.balance_usd.toFixed(2);
      refCount.textContent = userState.referrals.length;
      refLink.value = `${location.origin}${location.pathname}?start=ref_${userState.userId}`;
    }

    async function saveState(){
      localStorage.setItem("user_"+userState.userId, JSON.stringify(userState));
      await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
        method:"PUT",
        headers:{'Content-Type':'application/json','X-Master-Key':JSONBIN_API_KEY},
        body:JSON.stringify({users:{[userState.userId]:userState}})
      }).catch(()=>{});
    }

    async function loadState(){
      const local=localStorage.getItem("user_"+userState.userId);
      if(local){userState=JSON.parse(local);return;}
      try{
        const r=await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`,{headers:{'X-Master-Key':JSONBIN_API_KEY}});
        const j=await r.json();
        if(j.record && j.record.users && j.record.users[userState.userId]){
          userState=j.record.users[userState.userId];
        }
      }catch{}
    }

    async function fetchTonPrice(){
      try{
        const r=await fetch(PRICE_URL); const d=await r.json();
        return d.toncoin.usd;
      }catch{return null;}
    }

    async function init(){
      tg.ready();
      const user=tg.initDataUnsafe.user||{id:"guest"};
      userState.userId=user.id;
      await loadState();
      updateUI();
      const tonUsd=await fetchTonPrice();
      tonWarn.textContent = tonUsd?`1 TON = $${tonUsd}`:"Fiyat alınamadı";
    }

    watchAdBtn.onclick=async()=>{
      try{
        await window.showGiga();
        userState.balance_usd+=AD_REWARD_USD;
        await saveState(); updateUI();
        alert(`$${AD_REWARD_USD} kazandınız`);
      }catch{alert("Reklam izlenemedi");}
    };

    withdrawForm.onsubmit=async e=>{
      e.preventDefault();
      const usd=+withdrawAmt.value, addr=tonAddr.value;
      if(usd<MIN_WITHDRAW_USD||usd>userState.balance_usd)return alert("Geçersiz tutar");
      const tonUsd=await fetchTonPrice();
      const ton=tonUsd?(usd/tonUsd).toFixed(6):null;
      if(!confirm(`$${usd} ≈ ${ton} TON\nAdrese gönderilsin mi?\n${addr}`))return;
      userState.balance_usd-=usd; await saveState(); updateUI();
      await fetch(PIPEDREAM_ENDPOINT,{method:"POST",headers:{'Content-Type':'application/json'},
        body:JSON.stringify({userId:userState.userId,amount_usd:usd,ton_amount:ton,ton_address:addr,ts:Date.now()})});
      alert("İsteğiniz gönderildi");
    };

    init();
  })();
  </script>
</body>
            </html>
