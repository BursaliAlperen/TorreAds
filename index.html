<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TorreAds - Reklam İzle, TRON Kazan</title>
    
    <script src="https://adexora.com/cdn/ads.js?id=507"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #1e293b;
            --tg-theme-button-color: #3b82f6;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-hint-color: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --tg-theme-bg-color: #1e293b;
                --tg-theme-text-color: #f8fafc;
                --tg-theme-hint-color: #94a3b8;
            }
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--tg-theme-hint-color);
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 1.5rem;
            margin: 0;
            font-weight: 600;
        }

        .balance-card {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .balance-card h2 {
            margin: 0 0 5px 0;
            font-size: 1rem;
            font-weight: 400;
        }

        .balance-card p {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
        }

        .action-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
            margin-top: 10px;
        }

        .btn-primary {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: var(--tg-theme-hint-color);
            color: var(--tg-theme-button-text-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #4b5563;
        }

        .btn-loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn-loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-card {
            background-color: var(--tg-theme-bg-color);
            border: 1px solid var(--tg-theme-hint-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .info-card h3 {
            margin-top: 0;
            font-size: 1.1rem;
            border-bottom: 1px solid var(--tg-theme-hint-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .info-card p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .info-card span {
            font-weight: 600;
        }

        .tab-bar {
            display: flex;
            justify-content: space-around;
            background-color: var(--tg-theme-bg-color);
            border-top: 1px solid var(--tg-theme-hint-color);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px 0;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }

        .tab-button {
            background: none;
            border: none;
            color: var(--tg-theme-hint-color);
            cursor: pointer;
            padding: 10px 15px;
            text-align: center;
            font-size: 0.8rem;
            transition: color 0.2s;
        }

        .tab-button.active {
            color: var(--tg-theme-button-color);
        }

        .tab-button i {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        .content-area {
            padding-bottom: 70px; /* Space for the tab bar */
        }

        .view {
            display: none;
            animation: fadeIn 0.3s;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Withdrawal form */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--tg-theme-hint-color);
            border-radius: 6px;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        .input-group input:focus {
            border-color: var(--tg-theme-button-color);
            outline: none;
        }
        
        /* Status Message */
        .status-message {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            color: #ffffff;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .status-message.success {
            background-color: var(--success-color);
        }

        .status-message.error {
            background-color: var(--danger-color);
        }
        
        .referral-link {
            display: flex;
            align-items: center;
            background-color: var(--tg-theme-bg-color);
            border: 1px solid var(--tg-theme-hint-color);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .referral-link input {
            flex-grow: 1;
            border: none;
            background: none;
            color: var(--tg-theme-text-color);
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .referral-link button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }

        .admin-controls {
            margin-top: 30px;
            padding: 15px;
            border: 2px solid var(--danger-color);
            border-radius: 10px;
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        .admin-controls h3 {
            color: var(--danger-color);
            text-align: center;
        }
        
        .withdrawal-list {
            list-style: none;
            padding: 0;
        }

        .withdrawal-item {
            padding: 10px;
            border-bottom: 1px solid var(--tg-theme-hint-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .withdrawal-item:last-child {
            border-bottom: none;
        }

        .withdrawal-details {
            flex-grow: 1;
        }

        .withdrawal-actions button {
            margin-left: 10px;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .btn-approve {
            background-color: var(--success-color);
            color: white;
        }

        .btn-reject {
            background-color: var(--danger-color);
            color: white;
        }
    </style>
</head>
<body>
    
    <div id="loading" style="text-align: center; padding: 50px; font-size: 1.2rem;">
        <i class="fas fa-spinner fa-spin" style="margin-right: 10px;"></i> Uygulama Yükleniyor...
    </div>

    <div id="statusMessage" class="status-message"></div>
    
    <div id="app-container" class="container" style="display: none;">
        <div class="header">
            <h1 id="appTitle">TorreAds <span id="userIdDisplay"></span></h1>
        </div>

        <div class="content-area">
            
            <div id="main-view" class="view active">
                
                <div class="balance-card">
                    <h2>Mevcut Bakiye (TRX)</h2>
                    <p id="balanceDisplay">TRX 0.0000</p>
                    <p style="font-size: 0.9rem; font-weight: 400; margin-top: 5px;" id="usdEquivalent">≈ $0.00</p>
                </div>
                
                <button id="rewardedBtn" class="action-button btn-primary">
                    <i class="fas fa-video"></i> Reklam İzle ve Kazan
                </button>
                
                <p style="text-align: center; font-size: 0.9rem; color: var(--tg-theme-hint-color); margin-top: 15px;">
                    Bugün İzlenen Reklam: <span id="dailyAdCountDisplay">0 / 200</span>
                </p>

                <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--tg-theme-hint-color);">

                <div class="info-card">
                    <h3>Genel İstatistikler</h3>
                    <p>Toplam İzlenen Reklam: <span id="adCountDisplay">0</span></p>
                    <p>Toplam Çekilen Miktar: <span id="totalWithdrawalsDisplay">0 TRX</span></p>
                    <p>Toplam Dağıtılan Ödül: <span id="totalTRXDistributedDisplay">0 TRX</span></p>
                    <p>Güncel TRX Fiyatı: <span id="trxPriceDisplay">$0.00</span></p>
                </div>
            </div>

            <div id="withdraw-view" class="view">
                <div class="balance-card" style="background-color: var(--success-color);">
                    <h2>Çekilebilir Bakiye (TRX)</h2>
                    <p id="withdrawBalanceDisplay">TRX 0.0000</p>
                </div>
                
                <div class="input-group">
                    <label for="trxAddress">TRON (TRX) Cüzdan Adresi</label>
                    <input type="text" id="trxAddress" placeholder="TRX cüzdan adresinizi girin (T ile başlamalı)">
                </div>

                <p style="color: var(--tg-theme-hint-color); margin-top: 5px; text-align: center; font-size: 0.85rem;">
                    Minimum çekim miktarı <span id="minWithdrawalAmount">5</span> TRX'dir.
                </p>
                
                <button id="mainWithdrawBtn" class="action-button btn-secondary" onclick="showView('withdraw-final-view')">
                    <i class="fas fa-money-bill-wave"></i> Para Çek
                </button>
            </div>

            <div id="withdraw-final-view" class="view">
                <h3 style="text-align: center;">Çekim İşlemini Onayla</h3>
                <div class="info-card">
                    <p>Çekilecek Miktar: <span id="finalWithdrawAmountDisplay"></span></p>
                    <p>Cüzdan Adresi: <span id="finalWithdrawAddressDisplay"></span></p>
                </div>
                
                <button id="finalWithdrawBtn" class="action-button btn-primary" onclick="submitWithdrawal()">
                    <i class="fas fa-check-circle"></i> Onayla ve Çekim Talebi Oluştur
                </button>

                <button class="action-button btn-secondary" onclick="showView('withdraw-view')">
                    <i class="fas fa-arrow-left"></i> Geri Dön
                </button>
            </div>

            <div id="referral-view" class="view">
                <div class="info-card">
                    <h3>Davet Et, Kazan!</h3>
                    <p>Davet ettiğiniz her kullanıcı için size ve davet ettiğiniz kişiye <b><span id="referralBonusDisplay">$0.02</span></b> değerinde TRX hediye edilir.</p>
                    <p>Toplam Kazandığınız Referans Bonusu: <b><span id="referralBonusTotalDisplay">0.00 TRX</span></b></p>
                </div>
                
                <p>Davet Linkiniz:</p>
                <div class="referral-link">
                    <input type="text" id="referralLink" value="Yükleniyor..." readonly>
                    <button onclick="copyReferralCode()"><i class="fas fa-copy"></i> Kopyala</button>
                </div>
                
                <p style="margin-top: 20px;">Davet Edilen Kişi Sayısı: <span id="referredCountDisplay">0</span></p>
                
                <hr style="margin: 25px 0; border: none; border-top: 1px solid var(--tg-theme-hint-color);">
                
                <div id="referralCodeInputGroup" style="display: none;">
                    <h3 style="margin-bottom: 10px;">Davet Kodu Gir</h3>
                    <div class="input-group">
                        <input type="text" id="referralCodeInput" placeholder="Davet Kodunu Buraya Girin">
                    </div>
                    <button class="action-button btn-primary" onclick="submitReferralCode()">
                        <i class="fas fa-arrow-alt-circle-right"></i> Kodu Uygula
                    </button>
                </div>
            </div>

            <div id="admin-view" class="view">
                <div class="admin-controls">
                    <h3>Yönetici Paneli (Sunucuya Taşındı!)</h3>
                    <p style="color: var(--danger-color); font-weight: bold;">
                        DİKKAT: Tüm Admin Fonksiyonları SADECE Güvenli Sunucu (Backend) Üzerinden Çalışmalıdır. Bu görünüm sadece bilgilendirme amaçlıdır.
                    </p>
                </div>

                <div class="info-card" style="margin-top: 20px;">
                    <h3>Bekleyen Çekim Talepleri (<span id="withdrawalCount">0</span>)</h3>
                    <ul id="withdrawalList" class="withdrawal-list">
                        <li id="noWithdrawalsMessage" style="text-align: center; color: var(--tg-theme-hint-color);">Bekleyen çekim talebi yok.</li>
                    </ul>
                </div>
            </div>

        </div> <div class="tab-bar">
            <button class="tab-button active" data-view="main-view" onclick="showView('main-view')">
                <i class="fas fa-home"></i> Ana Sayfa
            </button>
            <button class="tab-button" data-view="withdraw-view" onclick="showView('withdraw-view')">
                <i class="fas fa-wallet"></i> Çekim
            </button>
            <button class="tab-button" data-view="referral-view" onclick="showView('referral-view')">
                <i class="fas fa-users"></i> Davet
            </button>
            <button id="adminTabBtn" class="tab-button" data-view="admin-view" onclick="showView('admin-view')" style="display: none;">
                <i class="fas fa-user-shield"></i> Admin
            </button>
        </div>
    </div> <script>
        // --- KRİTİK GÜVENLİK BİLGİLENDİRMESİ ---
        // Uygulamanın güvenliği için tüm master key'ler ve kritik işlemler sunucuya taşınmıştır.
        // Aşağıdaki kod, simüle edilmiş bir sunucu API'si üzerinden çalışır.

        // GÜVENLİK GEREĞİ KALDIRILMIŞ DEĞERLER (Sunucuya Taşınmalıdır)
        const BIN_ID = '68e2b3ebd0ea881f40965de6';
        // const MASTER_KEY = '$2a$10$Z5pw8wmihH97EgC6kgHAoebiEzuzhHLO361BA7ZAdTLZR.NY1gfK6'; // KALDIRILDI!
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}/latest`;
        const UPDATE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
        const SECURE_SERVER_ENDPOINT = 'YOUR_SECURE_BACKEND_API_ENDPOINT'; // BURAYI GERÇEK SUNUCU ADRESİNİZLE DEĞİŞTİRİN!

        // Telegram Web App nesnesi
        const tg = window.Telegram.WebApp;

        // Uygulama verileri
        let userData = null;
        let appData = {
            users: {},
            system: {
                // HARDCODED DEĞERLER MERKEZİLEŞTİRİLDİ
                adminUsers: ['8401848644', '7904032877'], 
                DAILY_AD_LIMIT: 200,             
                MIN_WITHDRAWAL_TRX: 5,           
                AD_REWARD_USD: 0.001,            
                REFERRAL_BONUS_USD: 0.02,        
                
                // İstatistikler
                totalAds: 0,
                totalWithdrawals: 0,
                totalTRXDistributed: 0,
                lastAdReset: new Date().toDateString(),
                trxPrice: 0.12, 
                trxChange: 0,
            },
            withdrawRequests: []
        };
        let trxPrice = 0.12;
        let trxChange = 0;


        // --- GÜVENLİK AMAÇLI MOCK SUNUCU İŞLEVLERİ (GERÇEK SUNUCU İLE DEĞİŞTİRİLMELİ) ---
        
        // JSONBin.io'dan veri yükleme (Sadece MOCK için kullanılmıştır, güvenli değildir)
        async function loadAppDataLegacy() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.record;
            } catch (error) {
                console.error('Legacy Veri Yükleme Başarısız:', error);
                return null;
            }
        }

        // JSONBin.io'ya veri kaydetme (Sadece MOCK için kullanılmıştır, güvenli değildir)
        async function saveAppDataLegacy(data) {
            try {
                const response = await fetch(UPDATE_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        // MASTER KEY KALDIRILDI!
                        'X-Bin-Versioning': 'false'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Legacy Veri Kaydetme Başarısız:', error);
                return false;
            }
        }
        
        // Simüle Edilmiş Güvenli Sunucu API'si (Tüm KRİTİK İŞLEMLER BURADAN YAPILMALI)
        const secureServer = {
            // Veri Çekme
            async fetchAppData() {
                // GERÇEKTE: await fetch(`${SECURE_SERVER_ENDPOINT}/data?userId=${tg.initDataUnsafe.user.id}`);
                return loadAppDataLegacy(); // Geçici MOCK
            },
            // Veri Kaydetme
            async saveAppData(data) {
                // GERÇEKTE: await fetch(`${SECURE_SERVER_ENDPOINT}/update`, { method: 'POST', body: JSON.stringify(data) });
                return saveAppDataLegacy(data); // Geçici MOCK
            },
            // Admin fonksiyonları sunucuya taşınmalıdır
            async adminAddBalance(targetId, amount) {
                showStatus('KRİTİK HATA: Admin fonksiyonu sunucuya taşınmalıdır.', 'error');
                return false;
            },
            async approveWithdrawal(requestId) {
                showStatus('KRİTİK HATA: Onaylama fonksiyonu sunucuya taşınmalıdır.', 'error');
                return false;
            },
            async rejectWithdrawal(requestId) {
                showStatus('KRİTİK HATA: Reddetme fonksiyonu sunucuya taşınmalıdır.', 'error');
                return false;
            }
        };


        // --- YARDIMCI İŞLEVLER ---

        function usdToTRX(usd) {
            return trxPrice > 0 ? usd / trxPrice : 0;
        }

        function getUserId() {
            return tg.initDataUnsafe.user ? String(tg.initDataUnsafe.user.id) : null;
        }

        function checkAdminStatus() {
            const userId = getUserId();
            return userId && appData.system.adminUsers.includes(userId);
        }

        function updateUI() {
            if (!userData) return;
            
            const dailyLimit = appData.system.DAILY_AD_LIMIT;
            const minWithdrawal = appData.system.MIN_WITHDRAWAL_TRX;
            const refBonus = appData.system.REFERRAL_BONUS_USD;

            // Bakiye Güncellemeleri
            document.getElementById('balanceDisplay').textContent = `TRX ${userData.balance.toFixed(4)}`;
            const usdEquivalent = userData.balance * trxPrice;
            document.getElementById('usdEquivalent').textContent = `≈ $${usdEquivalent.toFixed(4)}`;
            document.getElementById('withdrawBalanceDisplay').textContent = `TRX ${userData.balance.toFixed(4)}`;

            // Sayac Güncellemeleri
            document.getElementById('adCountDisplay').textContent = appData.system.totalAds;
            document.getElementById('dailyAdCountDisplay').textContent = `${userData.dailyAdCount} / ${dailyLimit}`;

            // İstatistikler
            document.getElementById('totalWithdrawalsDisplay').textContent = `${appData.system.totalWithdrawals.toFixed(2)} TRX`;
            document.getElementById('totalTRXDistributedDisplay').textContent = `${appData.system.totalTRXDistributed.toFixed(2)} TRX`;
            document.getElementById('trxPriceDisplay').textContent = `$${trxPrice.toFixed(4)}`;

            // Referans Güncellemeleri
            document.getElementById('referralBonusDisplay').textContent = `$${refBonus}`;
            document.getElementById('referredCountDisplay').textContent = userData.referredUsers.length;
            document.getElementById('referralBonusTotalDisplay').textContent = `${userData.referralBonus.toFixed(4)} TRX`;
            const userId = getUserId();
            document.getElementById('referralLink').value = `https://t.me/${tg.initDataUnsafe.user.username || 'share' }?start=${userId}`;

            // Admin Kontrolü
            if (checkAdminStatus()) {
                document.getElementById('adminTabBtn').style.display = 'block';
                renderWithdrawalRequests();
            } else {
                 document.getElementById('adminTabBtn').style.display = 'none';
            }
            
            updateWithdrawButton();
        }

        function updateWithdrawButton() {
            const mainWithdrawBtn = document.getElementById('mainWithdrawBtn');
            const finalWithdrawBtn = document.getElementById('finalWithdrawBtn');
            const minWithdrawal = appData.system.MIN_WITHDRAWAL_TRX;

            if (userData.balance >= minWithdrawal) {
                mainWithdrawBtn.disabled = false;
                mainWithdrawBtn.innerHTML = '<i class="fas fa-money-bill-wave"></i> Para Çek';
                
                const address = document.getElementById('trxAddress').value.trim() || userData.paymentAddress;
                // Adres T ile başlıyor ve en az 34 karakter uzunluğunda mı (Basit TRX kontrolü)
                if (address && address.startsWith('T') && address.length >= 34) { 
                    finalWithdrawBtn.disabled = false;
                } else {
                    finalWithdrawBtn.disabled = true;
                }
            } else {
                mainWithdrawBtn.disabled = true;
                const remaining = (minWithdrawal - userData.balance).toFixed(2);
                mainWithdrawBtn.innerHTML = `<i class="fas fa-money-bill-wave"></i> Çekim İçin ${remaining} TRX Eksik`;
                finalWithdrawBtn.disabled = true;
            }
        }
        
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`.tab-button[data-view="${viewId.replace('-final-view', '-view')}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Çekim Onayı Görünümünü Yönetme
            if (viewId === 'withdraw-final-view') {
                const address = document.getElementById('trxAddress').value.trim();
                const amount = userData.balance.toFixed(4);

                // Adresi kaydet ve UI'da göster
                userData.paymentAddress = address; 
                document.getElementById('finalWithdrawAmountDisplay').textContent = `${amount} TRX`;
                document.getElementById('finalWithdrawAddressDisplay').textContent = address;
                
                updateWithdrawButton();
            }
            
            tg.ready();
        }
        
        function checkDailyReset() {
            const today = new Date().toDateString();

            // Uygulama istatistiklerini sıfırla (Günde bir kez)
            if (appData.system.lastAdReset !== today) {
                appData.system.lastAdReset = today;
                // Diğer global istatistiklerin sıfırlanması gerekirse buraya eklenmeli
            }

            // Kullanıcı reklam sayısını sıfırla
            if (userData.lastAdDate !== today) {
                userData.dailyAdCount = 0;
                userData.lastAdDate = today;
            }
        }

        // --- ANA UYGULAMA İŞLEVLERİ ---

        async function initApp() {
            tg.ready();
            tg.expand();
            tg.MainButton.hide();

            // 1. Verileri Yükle
            const loadedData = await secureServer.fetchAppData();
            if (loadedData) {
                // appData'yı güncelleyip yüklenen verilerle birleştirme
                appData = {...appData, ...loadedData};
            }

            // 2. Kullanıcıyı Bul veya Oluştur
            const userId = getUserId();
            if (!userId) {
                document.getElementById('loading').textContent = 'Kullanıcı kimliği alınamadı. Lütfen Telegram içinden açın.';
                return;
            }
            
            document.getElementById('userIdDisplay').textContent = `(${tg.initDataUnsafe.user.username || tg.initDataUnsafe.user.id})`;

            if (!appData.users[userId]) {
                // Yeni Kullanıcı Oluşturma
                userData = {
                    balance: 0,
                    adCount: 0,
                    dailyAdCount: 0,
                    lastAdDate: new Date().toDateString(),
                    referredBy: null,
                    referredUsers: [],
                    referralBonus: 0,
                    paymentAddress: '',
                    isBlocked: false,
                    lastUpdated: Date.now()
                };
                appData.users[userId] = userData;
                // Yeni kullanıcıyı kaydetme (Veri Kaydetme Hatası Düzeltmesi)
                await secureServer.saveAppData(appData); 
            } else {
                userData = appData.users[userId];
            }
            
            // 3. Güncel TRX Fiyatını Yükle
            await loadTRXPrice();

            // 4. Günlük Sıfırlama Kontrolü ve Yönlendirme Kodu Kontrolü
            checkDailyReset();
            const startParam = tg.initDataUnsafe.start_param;
            if (startParam && startParam !== userId && userData.referredBy === null) {
                await applyReferralCode(startParam);
            }

            // 5. UI Hazırla
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('trxAddress').value = userData.paymentAddress;
            
            if (userData.referredBy !== null) {
                document.getElementById('referralCodeInputGroup').style.display = 'none';
            } else {
                document.getElementById('referralCodeInputGroup').style.display = 'block';
            }
            
            updateUI();
            
            // 6. Periyodik Güncellemeleri Başlat
            startPeriodicUpdates();
        }

        async function loadTRXPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tron&vs_currencies=usd&include_24hr_change=true');
                if (!response.ok) {
                    throw new Error('CoinGecko API error');
                }
                const data = await response.json();
                
                if (data.tron) {
                    trxPrice = data.tron.usd;
                    trxChange = data.tron.usd_24h_change;
                    appData.system.trxPrice = trxPrice; // appData'da da tutarlılık için güncelle
                    updateUI(); 
                }
            } catch (error) {
                console.error('TRX Fiyatı yüklenemedi, varsayılan kullanılıyor:', error);
            }
        }
        
        // Reklam İzle ve Bakiye Ekle (Veri Kaydetme Hatası Düzeltmesi burada uygulandı)
        async function watchAd() {
            const btn = document.getElementById('rewardedBtn');
            const adLimit = appData.system.DAILY_AD_LIMIT;
            const adReward = appData.system.AD_REWARD_USD;

            checkDailyReset(); 

            if (userData.dailyAdCount >= adLimit) {
                showStatus('Günlük reklam limitine ulaştınız. Yarın tekrar deneyin.', 'error', 3000);
                return;
            }
            
            if (userData.isBlocked) {
                showStatus('Hesabınız bloke edilmiştir. Destek ile iletişime geçin.', 'error', 3000);
                return;
            }

            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                const rewarded = await window.adexora.showRewarded();
                
                if (rewarded) {
                    // Ödül Hesaplama
                    const rewardAmount = usdToTRX(adReward); 
                    
                    // Verileri Güncelle
                    userData.balance += rewardAmount;
                    userData.adCount += 1;
                    userData.dailyAdCount += 1;
                    userData.lastUpdated = Date.now();
                    
                    appData.system.totalAds += 1; // Merkezi istatistik güncellemesi
                    appData.system.totalTRXDistributed += rewardAmount;
                    
                    // Veritabanına Kaydet (Veri Bütünlüğü İçin Kritik Adım)
                    await secureServer.saveAppData(appData);
                    
                    showStatus(`Tebrikler! ${rewardAmount.toFixed(4)} TRX kazandınız.`, 'success', 3000);
                } else {
                    showStatus('Reklam gösterilemedi veya izlenmedi.', 'error', 3000);
                }
                
            } catch (error) {
                console.error('Reklam izleme hatası:', error);
                showStatus('Bir hata oluştu. Tekrar deneyin.', 'error', 3000);
            } finally {
                // KRİTİK DÜZELTME: İşlem bittikten sonra veriyi yeniden çek
                await secureServer.fetchAppData(); 
                updateUI();
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        }

        // Çekim Talebi Gönder (Veri Kaydetme Hatası Düzeltmesi burada uygulandı)
        async function submitWithdrawal() {
            const address = userData.paymentAddress.trim();
            const minWithdrawal = appData.system.MIN_WITHDRAWAL_TRX;
            const amount = userData.balance;

            if (!address || !address.startsWith('T') || address.length < 34) {
                showStatus('Geçerli bir TRON cüzdan adresi girin.', 'error', 3000);
                return;
            }

            if (amount < minWithdrawal) {
                showStatus(`Minimum çekim miktarı ${minWithdrawal} TRX'dir.`, 'error', 3000);
                return;
            }
            
            if (userData.isBlocked) {
                showStatus('Hesabınız bloke edilmiştir.', 'error', 3000);
                return;
            }

            try {
                // Çekim talebi oluştur
                const withdrawalRequest = {
                    id: Date.now(),
                    userId: getUserId(),
                    username: tg.initDataUnsafe.user.username || 'N/A',
                    amount: amount,
                    address: address,
                    date: new Date().toLocaleDateString('tr-TR'),
                    status: 'Beklemede'
                };
                
                // Verileri Güncelle (Bakiye sıfırla, istek ekle)
                appData.system.totalWithdrawals += amount; // Merkezi istatistik güncellemesi
                userData.balance = 0;
                userData.lastUpdated = Date.now();
                appData.withdrawRequests.push(withdrawalRequest);

                // Veritabanına Kaydet
                await secureServer.saveAppData(appData);
                
                showStatus('Çekim talebiniz başarıyla oluşturuldu. En kısa sürede onaylanacaktır.', 'success', 5000);
                showView('main-view'); 
            } catch (error) {
                console.error('Çekim talebi hatası:', error);
                showStatus('Çekim talebi gönderilirken bir hata oluştu.', 'error', 3000);
            } finally {
                // KRİTİK DÜZELTME: İşlem bittikten sonra veriyi yeniden çek
                await secureServer.fetchAppData();
                updateUI();
            }
        }

        // Referans Kodu Uygula (Veri Kaydetme Hatası Düzeltmesi burada uygulandı)
        async function applyReferralCode(referralCode) {
            const referrerId = referralCode;
            const referredId = getUserId();
            const referrer = appData.users[referrerId];
            const bonusAmount = usdToTRX(appData.system.REFERRAL_BONUS_USD);

            if (referrerId === referredId) {
                showStatus('Kendi referans kodunuzu giremezsiniz.', 'error', 3000);
                return false;
            }

            if (userData.referredBy !== null) {
                showStatus('Zaten bir referans kodu kullandınız.', 'error', 3000);
                return false;
            }

            if (!referrer) {
                showStatus('Geçersiz referans kodu.', 'error', 3000);
                return false;
            }
            
            try {
                // Referansçı ve Yönlendirilen Kullanıcıyı Güncelle
                userData.balance += bonusAmount;
                userData.referralBonus += bonusAmount;
                userData.referredBy = referrerId;
                userData.lastUpdated = Date.now();
                
                referrer.balance += bonusAmount;
                referrer.referralBonus += bonusAmount;
                referrer.referredUsers.push(referredId);
                referrer.lastUpdated = Date.now();
                
                // Veriyi kaydet
                await secureServer.saveAppData(appData); 
                
                showStatus(`Başarılı! ${bonusAmount.toFixed(4)} TRX referans bonusu kazandınız.`, 'success', 5000);
                
                document.getElementById('referralCodeInputGroup').style.display = 'none';
                return true;
                
            } catch (error) {
                console.error('Referans kodu uygulama hatası:', error);
                showStatus('Referans kodu uygulanırken bir hata oluştu.', 'error', 3000);
                return false;
            } finally {
                // KRİTİK DÜZELTME: İşlem bittikten sonra veriyi yeniden çek
                await secureServer.fetchAppData(); 
                updateUI();
            }
        }

        function submitReferralCode() {
            const code = document.getElementById('referralCodeInput').value.trim();
            if (code) {
                applyReferralCode(code);
            } else {
                showStatus('Lütfen bir davet kodu girin.', 'error', 3000);
            }
        }
        
        // --- YÖNETİCİ İŞLEVLERİ (SADECE MOCK/UI AMAÇLI) ---
        
        function renderWithdrawalRequests() {
            const list = document.getElementById('withdrawalList');
            const requests = appData.withdrawRequests.filter(r => r.status === 'Beklemede');
            
            list.innerHTML = '';
            document.getElementById('withdrawalCount').textContent = requests.length;

            if (requests.length === 0) {
                list.innerHTML = `<li id="noWithdrawalsMessage" style="text-align: center; color: var(--tg-theme-hint-color);">Bekleyen çekim talebi yok.</li>`;
                return;
            }

            requests.forEach(req => {
                const item = document.createElement('li');
                item.className = 'withdrawal-item';
                item.innerHTML = `
                    <div class="withdrawal-details">
                        <p style="margin: 0; font-weight: 600;">${req.amount.toFixed(4)} TRX</p>
                        <p style="margin: 0; font-size: 0.8rem; color: var(--tg-theme-hint-color);">@${req.username} | ${req.date}</p>
                        <p style="margin: 0; font-size: 0.8rem; word-break: break-all;">Adres: ${req.address}</p>
                    </div>
                    <div class="withdrawal-actions">
                        <button class="btn-approve" onclick="secureServer.approveWithdrawal(${req.id})"><i class="fas fa-check"></i> Onayla</button>
                        <button class="btn-reject" onclick="secureServer.rejectWithdrawal(${req.id})"><i class="fas fa-times"></i> Reddet</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        // --- PERİYODİK GÜNCELLEMELER (Veri Bütünlüğü İçin Senkronizasyon) ---

        function startPeriodicUpdates() {
            // Veri çakışmasını azaltmak için kısa aralıkta (10 saniye) veri çek
            setInterval(async () => {
                const loadedData = await secureServer.fetchAppData();
                if (loadedData) {
                    // Yüklenen veriyi mevcut appData ile birleştirme
                    appData = {...appData, ...loadedData};
                    if (appData.users[getUserId()]) {
                        userData = appData.users[getUserId()];
                        checkDailyReset();
                        updateUI();
                    }
                }
            }, 10000);
            
            // TRX fiyatını her 5 dakikada bir güncelle
            setInterval(async () => {
                await loadTRXPrice();
            }, 300000);
        }
        
        // --- UTILITY (YARDIMCI) İŞLEVLER ---

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus('Kopyalandı!', 'success', 1000);
            }).catch(err => {
                console.error('Copy failed:', err);
                showStatus('Kopyalama başarısız. Manuel olarak kopyalayın.', 'error', 2000);
            });
        }
        
        function copyReferralCode() {
            const link = document.getElementById('referralLink').value;
            copyToClipboard(link);
        }

        function showStatus(message, type, duration = 3000) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, duration);
        }
        
        // Olay dinleyicileri
        document.getElementById('rewardedBtn').addEventListener('click', watchAd);
        document.getElementById('trxAddress').addEventListener('input', updateWithdrawButton);
        document.addEventListener('DOMContentLoaded', initApp);

        // HTML onclick'ler için gerekli global erişimler
        window.showView = showView;
        window.copyReferralCode = copyReferralCode;
        window.submitWithdrawal = submitWithdrawal;
        window.submitReferralCode = submitReferralCode;
        
        // Güvenlik uyarısı: Admin fonksiyonları tarayıcıdan çalıştırılamaz!
        window.adminAddBalance = secureServer.adminAddBalance;
        window.approveWithdrawal = secureServer.approveWithdrawal;
        window.rejectWithdrawal = secureServer.rejectWithdrawal;
    </script>
</body>
</html>
