<script>
  const btn = document.getElementById("watchAdBtn");
  const status = document.getElementById("status");
  const balanceDisplay = document.getElementById("balance");

  let userToken = localStorage.getItem("userToken") || null;
  const urlParams = new URLSearchParams(window.location.search);
  const referrerToken = urlParams.get("ref");

  // Kullanıcıyı backend'den al veya oluştur
  async function fetchUser() {
    const res = await fetch("/api/user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userToken, referrerToken })
    });

    const data = await res.json();
    userToken = data.token;
    localStorage.setItem("userToken", userToken);
    balanceDisplay.textContent = parseFloat(data.balance).toFixed(4);
  }

  fetchUser(); // Sayfa açılınca kullanıcıyı yükle

  // SDK hazır mı kontrol et
  function waitForSDK(retries = 20, delay = 500) {
    return new Promise((resolve, reject) => {
      let attempt = 0;
      const check = () => {
        if (typeof show_9441902 === "function") resolve();
        else if (attempt++ >= retries) reject("❌ Reklam SDK yüklenemedi.");
        else setTimeout(check, delay);
      };
      check();
    });
  }

  waitForSDK()
    .then(() => {
      btn.disabled = false;
      btn.textContent = "🎥 Reklamı İzle";
      status.textContent = "Reklam hazır.";
    })
    .catch(err => {
      status.textContent = err;
    });

  // 18 saniyelik bekleme fonksiyonu
  function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    status.textContent = "Reklam başlatılıyor...";

    try {
      await show_9441902();

      status.textContent = "18 saniye bekleniyor...";
      await delay(18000);  // 18 saniye bekle

      // Reklam tamamlandı, backend'e bildir
      const res = await fetch("/api/reward", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userToken })
      });

      const data = await res.json();

      if (data.success) {
        balanceDisplay.textContent = parseFloat(data.newBalance).toFixed(4);
        status.textContent = "🎉 0.0001 TON hesabınıza eklendi!";
      } else {
        status.textContent = "❌ Ödül eklenemedi: " + (data.error || "Bilinmeyen hata");
      }
    } catch (e) {
      status.textContent = "❌ Reklam gösterilemedi.";
    } finally {
      btn.disabled = false;
      btn.textContent = "🎥 Reklamı İzle";
    }
  });
    </script>
    

// Rewarded Popup

show_9441902('pop').then(() => {
    // user watch ad till the end or close it in interstitial format
    // your code to reward user for rewarded format
}).catch(e => {
    // user get error during playing ad
    // do nothing or whatever you want
})

        
