<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ¬ Reklam Ä°zle, TON Kazan</title>

  <!-- Tek bir SDK script Ã§aÄŸrÄ±sÄ± -->
  <script src="https://libtl.com/sdk.js" data-zone="9441902" data-sdk="show_9441902"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 50px;
      background: #f9f9f9;
      color: #333;
    }
    h1 {
      font-size: 30px;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    p, #balance {
      font-size: 20px;
      margin-bottom: 20px;
    }
    button {
      padding: 14px 28px;
      font-size: 20px;
      background-color: #27ae60;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
    }
    #status {
      margin-top: 30px;
      font-weight: 600;
      font-size: 18px;
      min-height: 28px;
      color: #2980b9;
    }
  </style>
</head>
<body>

<h1>ğŸ¬ Reklam Ä°zle, <br> 0.0001 TON Kazan!</h1>
<p>ReklamÄ± izleyerek TON bakiyeni artÄ±r.</p>

<p>ğŸ’° Bakiye: <span id="balance">0.0000</span> TON</p>

<button id="watchAdBtn" disabled>ğŸ”„ Reklam YÃ¼kleniyor...</button>

<div id="status">LÃ¼tfen bekleyin...</div>

<script>
  const API_BASE = "http://127.0.0.1:5001";  // Backend API adresi
  const REWARD_AMOUNT = 0.0001;

  const btn = document.getElementById("watchAdBtn");
  const status = document.getElementById("status");
  const balanceDisplay = document.getElementById("balance");

  // KullanÄ±cÄ± tokenÄ± localStorage'da oluÅŸtur veya al
  function getUserToken() {
    let token = localStorage.getItem("user_token");
    if (!token) {
      token = crypto.randomUUID();
      localStorage.setItem("user_token", token);
    }
    return token;
  }

  // Backend'ten gÃ¼ncel bakiye Ã§ek
  async function fetchBalance() {
    const token = getUserToken();
    try {
      const response = await fetch(`${API_BASE}/api/balance/${token}`);
      if (!response.ok) throw new Error("Sunucudan bakiye alÄ±namadÄ±.");
      const data = await response.json();
      return parseFloat(data.bakiye) || 0;
    } catch (error) {
      console.error("fetchBalance error:", error);
      throw error;
    }
  }

  // Backend'e Ã¶dÃ¼l talebi gÃ¶nder, yeni bakiye dÃ¶ner
  async function claimReward() {
    const token = getUserToken();
    try {
      const response = await fetch(`${API_BASE}/api/reward`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token }),
      });
      if (!response.ok) throw new Error("Ã–dÃ¼l talebi baÅŸarÄ±sÄ±z.");
      const data = await response.json();
      if (!data.success) throw new Error(data.message || "Ã–dÃ¼l verilemedi.");
      return parseFloat(data.yeni_bakiye) || 0;
    } catch (error) {
      console.error("claimReward error:", error);
      throw error;
    }
  }

  // SDK'nÄ±n yÃ¼klendiÄŸini bekle (20 deneme, 500ms aralÄ±k)
  function waitForSDK(maxRetries = 20, delay = 500) {
    return new Promise((resolve, reject) => {
      let attempts = 0;
      function check() {
        if (typeof show_9441902 === "function") {
          resolve();
        } else if (attempts >= maxRetries) {
          reject(new Error("Reklam SDK yÃ¼klenemedi."));
        } else {
          attempts++;
          setTimeout(check, delay);
        }
      }
      check();
    });
  }

  // EÄŸer SDK yoksa 19 saniyelik geri sayÄ±m simÃ¼le edilir
  function watchAdCountdown(seconds = 19) {
    return new Promise((resolve) => {
      let timeLeft = seconds;
      status.textContent = `â³ Reklam izleniyor: ${timeLeft} saniye kaldÄ±...`;
      btn.disabled = true;
      btn.textContent = `â³ ${timeLeft} sn bekleyin...`;

      const interval = setInterval(() => {
        timeLeft--;
        status.textContent = `â³ Reklam izleniyor: ${timeLeft} saniye kaldÄ±...`;
        btn.textContent = `â³ ${timeLeft} sn bekleyin...`;

        if (timeLeft <= 0) {
          clearInterval(interval);
          resolve();
        }
      }, 1000);
    });
  }

  // Sayfa ilk aÃ§Ä±ldÄ±ÄŸÄ±nda bakiye ve buton ayarlarÄ±nÄ± yap
  async function initialize() {
    try {
      const balance = await fetchBalance();
      balanceDisplay.textContent = balance.toFixed(4);
      status.textContent = "Reklam hazÄ±r.";
      btn.disabled = false;
      btn.textContent = "ğŸ¥ ReklamÄ± Ä°zle";
    } catch (error) {
      status.textContent = "âŒ Bakiye alÄ±namadÄ±, lÃ¼tfen sayfayÄ± yenileyin.";
      btn.disabled = true;
    }
  }

  btn.addEventListener("click", async () => {
    btn.disabled = true;
    status.textContent = "Reklam baÅŸlatÄ±lÄ±yor...";
    btn.textContent = "â³ Reklam oynatÄ±lÄ±yor...";

    try {
      if (typeof show_9441902 === "function") {
        // SDK reklamÄ±nÄ± gÃ¶ster
        await show_9441902();
      } else {
        // SDK yoksa 19 saniyelik sayaÃ§ ile reklam simÃ¼le et
        await watchAdCountdown(19);
      }

      // Reklam tamamlandÄ±, Ã¶dÃ¼l talep et
      const newBalance = await claimReward();

      balanceDisplay.textContent = newBalance.toFixed(4);
      status.textContent = `ğŸ‰ Tebrikler! ${REWARD_AMOUNT} TON bakiyene eklendi.`;
    } catch (error) {
      console.error(error);
      status.textContent = `âŒ Hata: ${error.message || "Reklam gÃ¶sterilemedi."}`;
    } finally {
      btn.disabled = false;
      btn.textContent = "ğŸ¥ ReklamÄ± Ä°zle";
    }
  });

  // Sayfa yÃ¼klenirken SDK'yÄ± bekle ve initialize et
  waitForSDK()
    .then(initialize)
    .catch((error) => {
      console.warn(error.message);
      status.textContent = error.message + " (Geri sayÄ±m modu aktif)";
      initialize(); // SDK olmasa da bakiye gÃ¶ster, buton aktif et
    });
</script>

</body>
</html>
